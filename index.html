<!DOCTYPE html>
<html lang="es-ES">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Ofertas</title>
  <!-- NOTA: Para producción, instalar Tailwind CSS localmente (no usar CDN) -->
  <script src="https://cdn.tailwindcss.com"></script>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  <script>
    tailwind.config = {
      theme: {
        extend: {
          colors: {
            dark: {
              950: '#050508',
              900: '#0a0a0f',
              850: '#0e0e14',
              800: '#121218',
              750: '#16161e',
              700: '#1a1a24',
              600: '#24242f',
              500: '#2e2e3a',
            },
            accent: {
              primary: '#3b82f6',
              secondary: '#06b6d4',
              tertiary: '#8b5cf6',
              gold: '#f59e0b',
              emerald: '#10b981',
              rose: '#ef4444',
              pink: '#ec4899',
            },
            neon: {
              blue: '#00d4ff',
              purple: '#bf00ff',
              green: '#00ff88',
            }
          },
          animation: {
            'pulse-slow': 'pulse 4s cubic-bezier(0.4, 0, 0.6, 1) infinite',
            'float': 'float 8s ease-in-out infinite',
            'glow': 'glow 3s ease-in-out infinite alternate',
            'slide-up': 'slideUp 0.6s cubic-bezier(0.16, 1, 0.3, 1)',
            'slide-down': 'slideDown 0.4s cubic-bezier(0.16, 1, 0.3, 1)',
            'fade-in': 'fadeIn 0.4s ease-out',
            'scale-in': 'scaleIn 0.3s cubic-bezier(0.16, 1, 0.3, 1)',
            'shimmer': 'shimmer 2s linear infinite',
            'border-flow': 'borderFlow 3s linear infinite',
            'spin-slow': 'spin 8s linear infinite',
            'bounce-subtle': 'bounceSubtle 2s ease-in-out infinite',
          },
          keyframes: {
            float: {
              '0%, 100%': { transform: 'translateY(0) rotate(0deg)' },
              '50%': { transform: 'translateY(-20px) rotate(5deg)' },
            },
            glow: {
              '0%': { boxShadow: '0 0 20px rgba(59, 130, 246, 0.3), 0 0 40px rgba(59, 130, 246, 0.1)' },
              '100%': { boxShadow: '0 0 40px rgba(59, 130, 246, 0.5), 0 0 80px rgba(59, 130, 246, 0.2)' },
            },
            slideUp: {
              '0%': { transform: 'translateY(30px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            slideDown: {
              '0%': { transform: 'translateY(-20px)', opacity: '0' },
              '100%': { transform: 'translateY(0)', opacity: '1' },
            },
            fadeIn: {
              '0%': { opacity: '0' },
              '100%': { opacity: '1' },
            },
            scaleIn: {
              '0%': { transform: 'scale(0.9)', opacity: '0' },
              '100%': { transform: 'scale(1)', opacity: '1' },
            },
            shimmer: {
              '0%': { backgroundPosition: '-200% 0' },
              '100%': { backgroundPosition: '200% 0' },
            },
            borderFlow: {
              '0%, 100%': { backgroundPosition: '0% 50%' },
              '50%': { backgroundPosition: '100% 50%' },
            },
            bounceSubtle: {
              '0%, 100%': { transform: 'translateY(0)' },
              '50%': { transform: 'translateY(-5px)' },
            },
          },
          backgroundImage: {
            'gradient-radial': 'radial-gradient(var(--tw-gradient-stops))',
            'gradient-conic': 'conic-gradient(from 180deg at 50% 50%, var(--tw-gradient-stops))',
          }
        }
      }
    }
  </script>
  <style>
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800&family=JetBrains+Mono:wght@400;500&display=swap');
    * { font-family: 'Inter', sans-serif; }
    .font-mono { font-family: 'JetBrains Mono', monospace; }
    body {
      background: #050508;
      min-height: 100vh;
      overflow-x: hidden;
    }
    /* Premium Glass Effects */
    .glass {
      background: linear-gradient(135deg, rgba(26, 26, 36, 0.8), rgba(18, 18, 24, 0.9));
      backdrop-filter: blur(20px) saturate(180%);
      border: 1px solid rgba(59, 130, 246, 0.08);
    }
    .glass-card {
      background: linear-gradient(145deg, rgba(26, 26, 36, 0.7), rgba(14, 14, 20, 0.9));
      backdrop-filter: blur(30px) saturate(200%);
      border: 1px solid rgba(255, 255, 255, 0.05);
      box-shadow: 
        0 4px 30px rgba(0, 0, 0, 0.3),
        inset 0 1px 0 rgba(255, 255, 255, 0.05);
    }
    .glass-strong {
      background: linear-gradient(145deg, rgba(18, 18, 24, 0.95), rgba(10, 10, 15, 0.98));
      backdrop-filter: blur(40px) saturate(200%);
      border: 1px solid rgba(59, 130, 246, 0.1);
    }
    /* Animated Gradient Border */
    .gradient-border {
      position: relative;
      border-radius: 16px;
    }
    .gradient-border::before {
      content: '';
      position: absolute;
      inset: -2px;
      padding: 2px;
      border-radius: inherit;
      background: linear-gradient(135deg, #3b82f6, #06b6d4, #8b5cf6, #3b82f6);
      background-size: 300% 300%;
      animation: borderFlow 4s ease infinite;
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.6;
      pointer-events: none; /* AÑADIDO: Para permitir clics a elementos debajo */
    }
    /* Glowing Text */
    .text-glow {
      text-shadow: 0 0 30px rgba(59, 130, 246, 0.5), 0 0 60px rgba(59, 130, 246, 0.3);
    }
    .text-gradient {
      background: linear-gradient(135deg, #3b82f6, #06b6d4, #8b5cf6);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    .text-gradient-gold {
      background: linear-gradient(135deg, #f59e0b, #fbbf24, #f59e0b);
      -webkit-background-clip: text;
      -webkit-text-fill-color: transparent;
      background-clip: text;
    }
    /* Premium Button Styles */
    .btn-premium {
      position: relative;
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border: none;
      overflow: hidden;
      transition: all 0.3s ease;
    }
    .btn-premium::before {
      content: '';
      position: absolute;
      top: 0;
      left: -100%;
      width: 100%;
      height: 100%;
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.2), transparent);
      transition: left 0.5s ease;
    }
    .btn-premium:hover::before {
      left: 100%;
    }
    .btn-premium:hover {
      transform: translateY(-2px);
      box-shadow: 0 10px 40px rgba(59, 130, 246, 0.4);
    }
    /* Animated Background Grid */
    .bg-grid {
      background-image: 
        linear-gradient(rgba(59, 130, 246, 0.03) 1px, transparent 1px),
        linear-gradient(90deg, rgba(59, 130, 246, 0.03) 1px, transparent 1px);
      background-size: 60px 60px;
      animation: gridMove 20s linear infinite;
    }
    @keyframes gridMove {
      0% { background-position: 0 0; }
      100% { background-position: 60px 60px; }
    }
    /* Floating Orbs */
    .orb {
      position: absolute;
      border-radius: 50%;
      filter: blur(80px);
      opacity: 0.4;
      animation: float 15s ease-in-out infinite;
    }
    .orb-1 {
      width: 400px;
      height: 400px;
      background: radial-gradient(circle, #3b82f6, transparent);
      top: -100px;
      right: -100px;
      animation-delay: 0s;
    }
    .orb-2 {
      width: 300px;
      height: 300px;
      background: radial-gradient(circle, #8b5cf6, transparent);
      bottom: -50px;
      left: -50px;
      animation-delay: -5s;
    }
    .orb-3 {
      width: 250px;
      height: 250px;
      background: radial-gradient(circle, #06b6d4, transparent);
      top: 50%;
      left: 50%;
      animation-delay: -10s;
    }
    /* Scrollbar */
    ::-webkit-scrollbar { width: 8px; height: 8px; }
    ::-webkit-scrollbar-track { background: rgba(26, 26, 36, 0.5); border-radius: 4px; }
    ::-webkit-scrollbar-thumb { 
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border-radius: 4px;
    }
    ::-webkit-scrollbar-thumb:hover { background: linear-gradient(135deg, #2563eb, #0891b2); }
    /* Status Pills */
    .status-pill {
      padding: 6px 14px;
      border-radius: 30px;
      font-size: 11px;
      font-weight: 600;
      text-transform: uppercase;
      letter-spacing: 0.8px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
    }
    .status-pill::before {
      content: '';
      width: 6px;
      height: 6px;
      border-radius: 50%;
      background: currentColor;
      animation: pulse 2s ease-in-out infinite;
    }
    /* Hover Glow Effect */
    .hover-glow {
      transition: all 0.4s cubic-bezier(0.16, 1, 0.3, 1);
    }
    .hover-glow:hover {
      transform: translateY(-4px);
      box-shadow: 
        0 20px 60px rgba(59, 130, 246, 0.2),
        0 0 40px rgba(59, 130, 246, 0.1);
    }
    .table-row-hover:hover {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.08), transparent);
      transform: translateX(5px);
    }
    /* Input Styles */
    input:-webkit-autofill,
    input:-webkit-autofill:hover,
    input:-webkit-autofill:focus {
      -webkit-box-shadow: 0 0 0 1000px #121218 inset !important;
      -webkit-text-fill-color: #e5e7eb !important;
    }
    /* Stat Card Gradient */
    .stat-card {
      position: relative;
      overflow: hidden;
    }
    .stat-card::after {
      content: '';
      position: absolute;
      top: 0;
      right: 0;
      width: 150px;
      height: 150px;
      background: radial-gradient(circle, var(--card-accent, rgba(59, 130, 246, 0.1)), transparent);
      pointer-events: none;
    }
    /* Table Row Hover */
    .table-row-hover {
      transition: all 0.3s ease;
    }
    /* Sidebar Active */
    .nav-link.active {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.15), transparent);
      border-left: 3px solid #3b82f6;
    }
    .nav-link.active i {
      color: #3b82f6 !important;
    }
    /* Loading Shimmer */
    .shimmer {
      background: linear-gradient(90deg, transparent, rgba(255,255,255,0.05), transparent);
      background-size: 200% 100%;
      animation: shimmer 2s infinite;
    }
    /* Kanban Column */
    .kanban-column {
      min-height: 400px;
    }
    /* Progress Ring */
    .progress-ring {
      transform: rotate(-90deg);
    }
    .progress-ring circle {
      transition: stroke-dashoffset 0.5s ease;
    }
    /* Modal Overlay */
    .modal-overlay {
      background: rgba(5, 5, 8, 0.9);
      backdrop-filter: blur(10px);
    }
    /* Notification Dot */
    .notif-dot {
      animation: pulse 2s ease-in-out infinite;
    }
    /* Command Palette */
    .command-item:hover {
      background: linear-gradient(90deg, rgba(59, 130, 246, 0.1), transparent);
    }
    /* Chart Container */
    .chart-container {
      position: relative;
      height: 250px;
    }
    /* Product Image */
    .product-image {
      width: 80px;
      height: 80px;
      object-fit: contain;
      background: rgba(255,255,255,0.05);
      border-radius: 8px;
      padding: 4px;
    }
    /* Badge improvements */
    .badge {
      display: inline-block;
      padding: 2px 8px;
      border-radius: 9999px;
      font-size: 0.75rem;
      font-weight: 500;
    }
    /* Custom scrollbar for modal content */
    #modalContent::-webkit-scrollbar {
      width: 6px;
    }
    #modalContent::-webkit-scrollbar-track {
      background: rgba(26, 26, 36, 0.3);
      border-radius: 3px;
    }
    #modalContent::-webkit-scrollbar-thumb {
      background: linear-gradient(135deg, #3b82f6, #06b6d4);
      border-radius: 3px;
    }
    #modalContent::-webkit-scrollbar-thumb:hover {
      background: linear-gradient(135deg, #2563eb, #0891b2);
    }
    /* Status icon animation */
    .status-icon {
      animation: pulse 2s infinite;
    }
    .ephemeral-notification-red {
      /* Base glass effect - slightly red-tinted over the dark background */
      background: linear-gradient(135deg, rgba(239, 68, 68, 0.2), rgba(239, 68, 68, 0.1));
      backdrop-filter: blur(25px) saturate(150%);
      border: 1px solid rgba(239, 68, 68, 0.3); /* Red border for a subtle glow */
      box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4), 0 0 40px rgba(239, 68, 68, 0.2); /* Red glow shadow */
    }

    /* NEW: Red Animated Gradient Border (specific for the notification) */
    .gradient-border-rose {
      position: relative;
      border-radius: 16px; /* Coincide con el rounded-xl del padre */
    }
    .gradient-border-rose::before {
      content: '';
      position: absolute;
      inset: -2px; /* Ajusta este valor si quieres un borde más o menos grueso */
      padding: 2px;
      border-radius: inherit;
      background: linear-gradient(135deg, #ef4444, #f87171, #fca5a5, #ef4444); /* Tonos rojos */
      background-size: 300% 300%;
      animation: borderFlow 4s ease infinite; /* Reutiliza la animación existente */
      -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
      -webkit-mask-composite: xor;
      mask-composite: exclude;
      opacity: 0.7; /* Más opaco que el original azul para destacar el rojo */
      pointer-events: none;
    }
    .ephemeral-notification-success {
        background: linear-gradient(135deg, rgba(16, 185, 129, 0.2), rgba(16, 185, 129, 0.1));
        backdrop-filter: blur(25px) saturate(150%);
        border: 1px solid rgba(16, 185, 129, 0.3);
        box-shadow: 0 4px 30px rgba(0, 0, 0, 0.4), 0 0 40px rgba(16, 185, 129, 0.2);
    }

    .gradient-border-emerald {
        position: relative;
        border-radius: 16px;
    }
    .gradient-border-emerald::before {
        content: '';
        position: absolute;
        inset: -2px;
        padding: 2px;
        border-radius: inherit;
        background: linear-gradient(135deg, #10b981, #34d399, #6ee7b7, #10b981); /* Tonos verdes */
        background-size: 300% 300%;
        animation: borderFlow 4s ease infinite;
        -webkit-mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        mask: linear-gradient(#fff 0 0) content-box, linear-gradient(#fff 0 0);
        -webkit-mask-composite: xor;
        mask-composite: exclude;
        opacity: 0.7;
        pointer-events: none;
    }
  </style>
</head>
<body class="text-gray-200">
  <div id="ephemeralNotification"
       class="fixed top-6 left-1/2 -translate-x-1/2 z-[110] p-4 rounded-xl shadow-lg
              ephemeral-notification-red gradient-border-rose text-white font-medium text-center flex items-center gap-3
              transition-all duration-500 ease-in-out transform -translate-y-full opacity-0 hidden
              w-full max-w-md">
      <i class="fas fa-exclamation-triangle text-rose-400 text-xl"></i>
      <span id="notificationMessage" class="text-lg"></span>
  </div>
  <!-- Animated Background -->
  <div class="fixed inset-0 pointer-events-none overflow-hidden">
    <div class="bg-grid absolute inset-0"></div>
    <div class="orb orb-1"></div>
    <div class="orb orb-2"></div>
    <div class="orb orb-3"></div>
  </div>

  <!-- Loading Overlay -->
  <div id="loadingOverlay" class="fixed inset-0 z-[100] hidden flex-col items-center justify-center modal-overlay">
    <div class="inline-flex items-center justify-center w-24 h-24 rounded-3xl bg-gradient-to-br from-accent-primary via-accent-secondary to-accent-tertiary mb-6 animate-pulse-slow shadow-xl shadow-accent-primary/50">
      <i class="fas fa-cube text-5xl text-white"></i>
    </div>
    <h2 class="text-2xl font-bold text-white mb-4 text-glow animate-fade-in animate-delay-300">Cargando datos...</h2>
    <div class="flex space-x-2 animate-fade-in animate-delay-500">
      <div class="w-3 h-3 bg-accent-primary rounded-full animate-bounce-subtle" style="animation-delay: 0s;"></div>
      <div class="w-3 h-3 bg-accent-secondary rounded-full animate-bounce-subtle" style="animation-delay: 0.2s;"></div>
      <div class="w-3 h-3 bg-accent-tertiary rounded-full animate-bounce-subtle" style="animation-delay: 0.4s;"></div>
    </div>
  </div>

  <!-- Login Screen -->
  <div id="loginScreen" class="fixed inset-0 z-50 flex items-center justify-center p-4">
    <div class="absolute inset-0 flex items-center justify-center">
      <div class="w-[600px] h-[600px] bg-accent-primary/10 rounded-full blur-[150px] animate-pulse-slow"></div>
    </div>
    <div class="relative glass-strong rounded-3xl p-10 w-full max-w-md animate-scale-in gradient-border">
      <!-- Logo & Branding -->
      <div class="text-center mb-10">
        <div class="inline-flex items-center justify-center w-20 h-20 rounded-2xl bg-gradient-to-br from-accent-primary via-accent-secondary to-accent-tertiary mb-6 animate-float shadow-lg shadow-accent-primary/30">
          <i class="fas fa-cube text-3xl text-white"></i>
        </div>
        <h1 class="text-3xl font-bold text-white text-glow mb-2">Ofertas</h1>
        <div class="flex items-center justify-center gap-4 mt-4">
          <span class="text-xs text-gray-500 flex items-center gap-1"><i class="fab fa-shopify text-green-500"></i> Shopify</span>
          <span class="text-xs text-gray-500">•</span>
          <span class="text-xs text-gray-500 flex items-center gap-1"><i class="fas fa-database text-emerald-500"></i> MongoDB</span>
          <span class="text-xs text-gray-500">•</span>
          <span class="text-xs text-gray-500 flex items-center gap-1"><i class="fas fa-chart-line text-blue-500"></i> Kommo</span>
        </div>
      </div>
      <form id="loginForm" class="space-y-6">
        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-300 flex items-center gap-2">
            <i class="fas fa-envelope text-accent-primary text-xs"></i>
            Correo electrónico
          </label>
          <div class="relative group">
            <input type="email" id="loginEmail" placeholder="correo" required
              class="w-full bg-dark-800 border border-dark-500 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary focus:ring-2 focus:ring-accent-primary/20 transition-all">
            <div class="absolute inset-0 rounded-xl bg-gradient-to-r from-accent-primary/10 to-accent-secondary/10 opacity-0 group-focus-within:opacity-100 transition-opacity pointer-events-none"></div>
          </div>
        </div>
        <div class="space-y-2">
          <label class="text-sm font-medium text-gray-300 flex items-center gap-2">
            <i class="fas fa-lock text-accent-primary text-xs"></i>
            Contraseña
          </label>
          <div class="relative group">
            <input type="password" id="loginPassword" placeholder="••••••••••••" required
              class="w-full bg-dark-800 border border-dark-500 rounded-xl py-4 px-5 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary focus:ring-2 focus:ring-accent-primary/20 transition-all">
            <button type="button" onclick="togglePasswordVisibility()" class="absolute right-4 top-1/2 -translate-y-1/2 text-gray-500 hover:text-gray-300 transition-colors">
              <i id="passwordIcon" class="fas fa-eye"></i>
            </button>
          </div>
        </div>
        <div id="loginError" class="hidden p-3 bg-rose-500/20 text-rose-400 rounded-xl text-sm font-medium animate-slide-up"></div>
        <button type="submit" class="btn-premium w-full text-white font-semibold py-4 rounded-xl flex items-center justify-center gap-3">
          <span>Iniciar Sesión</span>
          <i class="fas fa-arrow-right"></i>
        </button>
      </form>
    </div>
  </div>

  <!-- Main App -->
  <div id="mainApp" class="hidden min-h-screen">
    <!-- Sidebar -->
    <aside id="sidebar" class="fixed left-0 top-0 h-full w-72 glass-strong z-40 transform -translate-x-full lg:translate-x-0 transition-transform duration-500 ease-out border-r border-dark-600/50">
      <!-- Logo -->
      <div class="p-6 border-b border-dark-600/50">
        <div class="flex items-center gap-4">
          <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-accent-primary via-accent-secondary to-accent-tertiary flex items-center justify-center shadow-lg shadow-accent-primary/20">
            <i class="fas fa-cube text-white text-xl"></i>
          </div>
          <div>
            <h1 class="font-bold text-white text-lg">Ofertas</h1>
          </div>
        </div>
      </div>
      <!-- Navigation -->
      <nav class="p-4 space-y-1 overflow-y-auto max-h-[calc(100vh-200px)]">
        <p class="text-[10px] text-gray-500 uppercase tracking-widest px-4 mb-3 font-semibold">Principal</p>
        <a href="#" onclick="showSection('dashboard')" class="nav-link active flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:text-white transition-all group">
          <div class="w-9 h-9 rounded-lg bg-dark-700 group-hover:bg-accent-primary/20 flex items-center justify-center transition-all">
            <i class="fas fa-chart-pie text-sm"></i>
          </div>
          <span class="font-medium">Dashboard</span>
        </a>
        <a href="#" onclick="showSection('orders')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:text-white transition-all group">
          <div class="w-9 h-9 rounded-lg bg-dark-700 group-hover:bg-accent-primary/20 flex items-center justify-center transition-all">
            <i class="fas fa-shopping-bag text-sm"></i>
          </div>
          <span class="font-medium">Órdenes</span>
          <span class="ml-auto bg-accent-primary/20 text-accent-primary text-xs px-2 py-0.5 rounded-full" id="ordersCountBadge">0</span>
        </a>
        <a href="#" onclick="showSection('clients')" class="nav-link flex items-center gap-3 px-4 py-3 rounded-xl text-gray-300 hover:text-white transition-all group">
          <div class="w-9 h-9 rounded-lg bg-dark-700 group-hover:bg-accent-primary/20 flex items-center justify-center transition-all">
            <i class="fas fa-users text-sm"></i>
          </div>
          <span class="font-medium">Clientes</span>
          <span class="ml-auto bg-accent-primary/20 text-accent-primary text-xs px-2 py-0.5 rounded-full" id="clientsCountBadge">0</span>
        </a>
      </nav>
      <!-- User Profile -->
      <div class="absolute bottom-0 left-0 right-0 p-4 border-t border-dark-600/50 bg-dark-900/50">
        <div class="flex items-center gap-3">
          <div class="relative">
            <div class="w-11 h-11 rounded-xl bg-gradient-to-br from-accent-primary to-accent-tertiary flex items-center justify-center">
              <span id="userInitial" class="font-bold text-white text-lg">A</span>
            </div>
            <span class="absolute -bottom-0.5 -right-0.5 w-3.5 h-3.5 bg-green-500 border-2 border-dark-900 rounded-full"></span>
          </div>
          <div class="flex-1 min-w-0">
            <p id="userName" class="text-sm font-semibold text-white truncate">Admin User</p>
            <p id="userRole" class="text-xs text-gray-500 capitalize flex items-center gap-1">
              <span class="w-1.5 h-1.5 bg-accent-primary rounded-full"></span>
              Administrador
            </p>
          </div>
          <button onclick="logout()" class="p-2 text-gray-500 hover:text-rose-500 transition-colors rounded-lg hover:bg-rose-500/10">
            <i class="fas fa-sign-out-alt"></i>
          </button>
        </div>
      </div>
    </aside>

    <!-- Main Content -->
    <main class="lg:ml-72 min-h-screen">
      <!-- Top Bar -->
      <header class="sticky top-0 z-30 glass border-b border-dark-600/50">
        <div class="flex items-center justify-between px-4 lg:px-8 py-4">
          <div class="flex items-center gap-4">
            <button onclick="toggleSidebar()" class="lg:hidden p-2.5 text-gray-400 hover:text-white bg-dark-700 rounded-xl transition-colors">
              <i class="fas fa-bars"></i>
            </button>
            <!-- HEADER: Botón de búsqueda principal modificado -->
            <button onclick="openSearchModal()" class="flex items-center gap-3 bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 w-80 lg:w-[420px] text-left hover:border-dark-500 transition-colors group">
              <i class="fas fa-search text-gray-500 group-hover:text-accent-primary transition-colors"></i>
              <span class="text-gray-500 flex-1">Buscar órdenes, clientes...</span>
              <kbd class="hidden sm:inline-flex items-center gap-1 px-2 py-1 bg-dark-700 rounded text-xs text-gray-500">
                <span>⌘</span><span>K</span>
              </kbd>
            </button>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="showSection('settings')" class="p-2.5 text-gray-400 hover:text-white bg-dark-800 rounded-xl transition-colors">
              <i class="fas fa-cog"></i>
            </button>
          </div>
        </div>
      </header>

      <!-- Dashboard Section -->
      <section id="dashboardSection" class="p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4">
            <div>
              <h1 class="text-3xl font-bold text-white mb-2">Bienvenido de vuelta, <span class="text-gradient" id="welcomeName">Admin</span></h1>
              <p class="text-gray-400">Aquí tienes un resumen de tu ecommerce hoy</p>
            </div>
          </div>
        </div>
        <!-- Stats Grid -->
        <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6 mb-8">
          <!-- Total Orders -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(59, 130, 246, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-accent-primary/20 to-accent-primary/5 flex items-center justify-center">
                <i class="fas fa-shopping-bag text-accent-primary text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="totalOrders">0</p>
            <p class="text-gray-500 text-sm">Órdenes Totales</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-3/4 bg-gradient-to-r from-accent-primary to-accent-secondary rounded-full"></div>
            </div>
          </div>

          <!-- Revenue -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(16, 185, 129, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-500/5 flex items-center justify-center">
                <i class="fas fa-dollar-sign text-emerald-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="revenue">$0</p>
            <p class="text-gray-500 text-sm">Ingresos MXN</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-4/5 bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full"></div>
            </div>
          </div>

          <!-- Órdenes No Confirmadas -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(239, 68, 68, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-500/5 flex items-center justify-center">
                <i class="fas fa-question-circle text-rose-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="unconfirmedOrders">0</p>
            <p class="text-gray-500 text-sm">No Confirmadas</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-1/4 bg-gradient-to-r from-rose-500 to-rose-400 rounded-full"></div>
            </div>
          </div>

          <!-- Órdenes Confirmadas -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(59, 130, 246, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-blue-500/20 to-blue-500/5 flex items-center justify-center">
                <i class="fas fa-check-circle text-blue-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="confirmedOrders">0</p>
            <p class="text-gray-500 text-sm">Órdenes Confirmadas</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-2/3 bg-gradient-to-r from-blue-500 to-blue-400 rounded-full"></div>
            </div>
          </div>

          <!-- En Tránsito y Pronta Entrega -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(245, 158, 11, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-amber-500/20 to-amber-500/5 flex items-center justify-center">
                <i class="fas fa-truck-loading text-amber-500 text-xl"></i>
              </div>
              <div class="flex items-center gap-1 text-amber-400 text-sm font-medium bg-amber-400/10 px-2 py-1 rounded-lg">
                <i class="fas fa-clock text-xs"></i>
                <span>En Tránsito</span>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="inTransitAndSoon">0</p>
            <p class="text-gray-500 text-sm">En Tránsito</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-1/2 bg-gradient-to-r from-amber-500 to-amber-400 rounded-full"></div>
            </div>
          </div>

          <!-- Entregadas y Pagadas -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(16, 185, 129, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-emerald-500/20 to-emerald-500/5 flex items-center justify-center">
                <i class="fas fa-check-double text-emerald-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="deliveredAndPaid">0</p>
            <p class="text-gray-500 text-sm">Entregadas & Pagadas</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-5/6 bg-gradient-to-r from-emerald-500 to-emerald-400 rounded-full"></div>
            </div>
          </div>

          <!-- Entregadas y NO Pagadas -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(251, 191, 36, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-yellow-500/20 to-yellow-500/5 flex items-center justify-center">
                <i class="fas fa-exclamation-triangle text-yellow-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="deliveredAndUnpaid">0</p>
            <p class="text-gray-500 text-sm">Entregadas & Pendientes</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-1/3 bg-gradient-to-r from-yellow-500 to-yellow-400 rounded-full"></div>
            </div>
          </div>
          
          <!-- Órdenes Canceladas -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(239, 68, 68, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-rose-500/20 to-rose-500/5 flex items-center justify-center">
                <i class="fas fa-times-circle text-rose-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="canceledOrders">0</p>
            <p class="text-gray-500 text-sm">Órdenes Canceladas</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-1/5 bg-gradient-to-r from-rose-500 to-rose-400 rounded-full"></div>
            </div>
          </div>

          <!-- Valor Promedio de Orden (AOV) -->
          <div class="glass-card rounded-2xl p-6 hover-glow stat-card" style="--card-accent: rgba(139, 92, 246, 0.15);">
            <div class="flex items-start justify-between mb-4">
              <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-violet-500/20 to-violet-500/5 flex items-center justify-center">
                <i class="fas fa-chart-line text-violet-500 text-xl"></i>
              </div>
            </div>
            <p class="text-3xl font-bold text-white mb-1" id="averageOrderValue">$0</p>
            <p class="text-gray-500 text-sm">Valor Promedio de Orden</p>
            <div class="mt-4 h-1 bg-dark-600 rounded-full overflow-hidden">
              <div class="h-full w-[80%] bg-gradient-to-r from-violet-500 to-violet-400 rounded-full"></div>
            </div>
          </div>
        </div>
        <!-- Recent Orders -->
        <div class="grid grid-cols-1 lg:grid-cols-1 gap-6">
          <div class="lg:col-span-1 glass-card rounded-2xl overflow-hidden">
            <div class="flex items-center justify-between p-6 border-b border-dark-600/50">
              <div>
                <h3 class="text-lg font-semibold text-white">Órdenes Recientes</h3>
                <p class="text-sm text-gray-500">Últimas 5 órdenes</p>
              </div>
              <button onclick="showSection('orders')" class="text-accent-primary text-sm hover:underline flex items-center gap-2">
                Ver todas <i class="fas fa-arrow-right text-xs"></i>
              </button>
            </div>
            <div id="recentOrdersList" class="divide-y divide-dark-600/50">
              <!-- Populated by JS -->
            </div>
          </div>
        </div>
      </section>

      <!-- Clients Section -->
      <section id="clientsSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">Gestión de Clientes</h1>
            <p class="text-gray-400">Lista de todos tus clientes y sus compras</p>
          </div>
          <div class="flex items-center justify-between px-6 py-4 border-t border-dark-600/50">
            <p class="text-sm text-gray-500">Mostrando <span class="text-white font-medium" id="clientsShowing">0</span> de <span class="text-white font-medium" id="totalClientsCount">0</span></p>
            <div class="flex items-center gap-2" id="clientsPaginationControls">
              <!-- Pagination buttons -->
            </div>
          </div>
        </div>
        <!-- Filters -->
        <div class="glass-card rounded-2xl p-4 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
              <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                <input type="text" id="clientSearch" placeholder="Buscar por nombre, correo, teléfono..." 
                  oninput="filterClients()"
                  class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 pl-11 pr-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
              </div>
            </div>
            <select id="filterClientType" onchange="filterClients()" class="bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary min-w-[160px]">
              <option value="">Todos los tipos</option>
              <option value="client">Cliente</option>
              <option value="repeat">Recurrente</option>
            </select>
            <button onclick="clearClientFilters()" class="p-3 text-gray-500 hover:text-white bg-dark-800 border border-dark-600 rounded-xl transition-colors">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <!-- Clients Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-dark-750 border-b border-dark-600/50">
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Cliente</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Contacto</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Total Gastado</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Órdenes</th>
                </tr>
              </thead>
              <tbody id="clientsTableBody" class="divide-y divide-dark-600/30">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>

      <!-- Orders Section (Modificado para añadir botón de búsqueda avanzada) -->
      <section id="ordersSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">Gestión de Órdenes</h1>
            <p class="text-gray-400">Administra y rastrea todas tus órdenes en un solo lugar</p>
          </div>
          <div class="flex items-center gap-3">
            <button onclick="openSearchModal()" class="px-4 py-2.5 bg-dark-700 border border-dark-600 rounded-xl text-gray-300 text-sm font-medium hover:bg-dark-600 transition-colors flex items-center gap-2">
              <i class="fas fa-search-plus"></i>
              Filtro Avanzado
            </button>
            
          </div>
        </div>
        <!-- Filters (Existentes) -->
        <div class="glass-card rounded-2xl p-4 mb-6">
          <div class="flex flex-wrap items-center gap-4">
            <div class="flex-1 min-w-[200px]">
              <div class="relative">
                <i class="fas fa-search absolute left-4 top-1/2 -translate-y-1/2 text-gray-500"></i>
                <input type="text" id="orderSearch" placeholder="Buscar por orden, cliente, producto..." 
                  oninput="filterOrders()"
                  class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 pl-11 pr-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
              </div>
            </div>
            <select id="filterPayment" onchange="filterOrders()" class="bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary min-w-[160px]">
              <option value="">Todos los pagos</option>
              <option value="pre_shipping">Pre-envío</option>
              <option value="advanced_paid">Pago Adelantado</option>
              <option value="wait">Pendiente</option>
              <option value="paid">Completado</option>
              <option value="partial">Pago parcial</option>
              <option value="failed">Fallido</option>
            </select>
            <select id="filterOrigin" onchange="filterOrders()" class="bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary min-w-[140px]">
              <option value="">Todos los orígenes</option>
              <option value="facebook">Facebook</option>
              <option value="instagram">Instagram</option>
              <option value="google">Google</option>
              <option value="direct">Directo</option>
            </select>
            <button onclick="clearFilters()" class="p-3 text-gray-500 hover:text-white bg-dark-800 border border-dark-600 rounded-xl transition-colors">
              <i class="fas fa-times"></i>
            </button>
          </div>
        </div>
        <!-- Orders Table -->
        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-dark-750 border-b border-dark-600/50">
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Orden</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Monto</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Pago</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Envío</th>
                </tr>
              </thead>
              <tbody id="ordersTableBody" class="divide-y divide-dark-600/30">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
          <!-- Pagination -->
          <div class="flex items-center justify-between px-6 py-4 border-t border-dark-600/50">
            <p class="text-sm text-gray-500">Mostrando <span class="text-white font-medium" id="ordersShowing">0</span> de <span class="text-white font-medium" id="totalOrdersCount">0</span></p>
            <div class="flex items-center gap-2">
              <!-- Pagination buttons -->
            </div>
          </div>
        </div>
      </section>

      <!-- SEARCH RESULTS SECTION (NUEVA SECCIÓN AÑADIDA) -->
      <section id="resultsSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">Resultados de Búsqueda</h1>
            <p class="text-gray-400" id="resultsSubtitle">Se encontraron <span class="text-accent-primary font-semibold" id="resultsCount">0</span> órdenes que coinciden con tus criterios.</p>
          </div>
          <button onclick="goBackToDashboard()" class="px-4 py-2.5 bg-dark-700 border border-dark-600 rounded-xl text-gray-300 text-sm font-medium hover:bg-dark-600 transition-colors flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            Volver al Dashboard
          </button>
        </div>

        <div class="glass-card rounded-2xl overflow-hidden">
          <div class="overflow-x-auto">
            <table class="w-full">
              <thead>
                <tr class="bg-dark-750 border-b border-dark-600/50">
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Orden</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Cliente</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Monto</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Pago</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Envío</th>
                  <th class="text-left px-6 py-4 text-xs font-semibold text-gray-400 uppercase tracking-wider">Fecha Compra</th>
                </tr>
              </thead>
              <tbody id="searchResultsTableBody" class="divide-y divide-dark-600/30">
                <!-- Populated by JS -->
              </tbody>
            </table>
          </div>
        </div>
      </section>
      
      <section id="accionesSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="flex flex-col lg:flex-row lg:items-center justify-between gap-4 mb-8">
          <div>
            <h1 class="text-3xl font-bold text-white mb-2">Acciones</h1>
            <p class="text-gray-400" id="accionesSubtitle">Elige una acción para realizar</p>
          </div>
          <button onclick="showSection('dashboard')" class="px-4 py-2.5 bg-dark-700 border border-dark-600 rounded-xl text-gray-300 text-sm font-medium hover:bg-dark-600 transition-colors flex items-center gap-2">
            <i class="fas fa-arrow-left"></i>
            Volver al Dashboard
          </button>
        </div>

        <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
          <!-- Tarjeta: Crear Lead -->
          <div class="glass-card rounded-2xl p-6 hover-glow cursor-pointer flex flex-col justify-between" onclick="showCreateLeadForm()">
            <div>
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-xl bg-accent-primary/20 flex items-center justify-center">
                  <i class="fas fa-plus text-accent-primary text-xl"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white">Crear Lead</h3>
                  <p class="text-sm text-gray-500">Crea un lead a partir de esta orden</p>
                </div>
              </div>
            </div>
            <i class="fas fa-arrow-right ml-auto text-gray-500"></i>
          </div>

          <!-- Tarjeta: Añadir a Drive (Direcciones) -->
          <div class="glass-card rounded-2xl p-6 hover-glow cursor-pointer flex flex-col justify-between" onclick="addOrderToDrive()">
            <div>
              <div class="flex items-center gap-3 mb-4">
                <div class="w-12 h-12 rounded-xl bg-emerald-500/20 flex items-center justify-center">
                  <i class="fas fa-folder-plus text-emerald-500 text-xl"></i>
                </div>
                <div>
                  <h3 class="text-lg font-semibold text-white">Añadir a Drive</h3>
                  <p class="text-sm text-gray-500">Guarda los datos en el Drive de Direcciones</p>
                </div>
              </div>
            </div>
            <i class="fas fa-arrow-right ml-auto text-gray-500"></i>
          </div>

          <!-- Puedes añadir más tarjetas aquí -->
        </div>

        <!-- Formulario: Crear Lead (inicialmente oculto) -->
        <div id="createLeadForm" class="glass-card rounded-2xl p-6 mt-8 hidden">
          <h3 class="text-xl font-semibold text-white mb-4">Crear Lead</h3>
          <label class="block text-sm font-medium text-gray-300 mb-2">Motivo (obligatorio)</label>
          <textarea id="leadReason" rows="4" class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all"></textarea>
          <div class="flex justify-end mt-4">
            <button onclick="createLead()" class="btn-premium px-5 py-2.5 rounded-xl text-white font-medium">
              <i class="fas fa-plus mr-2"></i>Crear Lead
            </button>
          </div>
        </div>
      </section>

      <!-- Other sections (kanban, leads, analytics, etc.) -->
      <section id="kanbanSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Kanban</h1>
          <p class="text-gray-400">Vista Kanban de tus órdenes</p>
        </div>
        <div id="kanbanBoard" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6">
          <!-- Populated by JS -->
        </div>
      </section>
      <section id="leadsSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Gestión de Leads</h1>
          <p class="text-gray-400">Leads sincronizados desde Kommo CRM</p>
        </div>
        <div class="glass-card rounded-2xl p-12 text-center">
          <div class="w-20 h-20 rounded-2xl bg-blue-500/10 flex items-center justify-center mx-auto mb-6">
            <i class="fas fa-chart-line text-blue-500 text-3xl"></i>
          </div>
          <h3 class="text-xl font-semibold text-white mb-2">Conecta con Kommo</h3>
          <p class="text-gray-400 mb-6">Sincroniza tus leads y gestiónalos directamente desde aquí</p>
          <button class="btn-premium px-6 py-3 rounded-xl text-white font-medium">
            <i class="fas fa-plug mr-2"></i>Configurar Integración
          </button>
        </div>
      </section>
      <section id="analyticsSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Analytics</h1>
          <p class="text-gray-400">Métricas avanzadas y reportes</p>
        </div>
        <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">
          <div class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-6">Conversiones por Día</h3>
            <div class="chart-container">
              <canvas id="conversionsChart"></canvas>
            </div>
          </div>
          <div class="glass-card rounded-2xl p-6">
            <h3 class="text-lg font-semibold text-white mb-6">Top Productos</h3>
            <div class="space-y-4">
              <div class="flex items-center gap-4 p-4 bg-dark-700 rounded-xl">
                <div class="w-12 h-12 rounded-xl bg-accent-primary/20 flex items-center justify-center">
                  <i class="fas fa-box text-accent-primary"></i>
                </div>
                <div class="flex-1">
                  <p class="text-white font-medium">Cartera RFID Premium</p>
                  <p class="text-sm text-gray-500">342 ventas</p>
                </div>
                <span class="text-emerald-400 font-semibold">$338,580</span>
              </div>
              <div class="flex items-center gap-4 p-4 bg-dark-700 rounded-xl">
                <div class="w-12 h-12 rounded-xl bg-violet-500/20 flex items-center justify-center">
                  <i class="fas fa-box text-violet-500"></i>
                </div>
                <div class="flex-1">
                  <p class="text-white font-medium">Smart Watch Pro X</p>
                  <p class="text-sm text-gray-500">189 ventas</p>
                </div>
                <span class="text-emerald-400 font-semibold">$300,510</span>
              </div>
              <div class="flex items-center gap-4 p-4 bg-dark-700 rounded-xl">
                <div class="w-12 h-12 rounded-xl bg-amber-500/20 flex items-center justify-center">
                  <i class="fas fa-box text-amber-500"></i>
                </div>
                <div class="flex-1">
                  <p class="text-white font-medium">Creatina Pro Max</p>
                  <p class="text-sm text-gray-500">156 ventas</p>
                </div>
                <span class="text-emerald-400 font-semibold">$201,240</span>
              </div>
            </div>
          </div>
        </div>
      </section>
      <section id="shopifySection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Shopify</h1>
          <p class="text-gray-400">Estado de la integración con Shopify</p>
        </div>
        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center gap-4 mb-6">
            <div class="w-16 h-16 rounded-2xl bg-green-500/10 flex items-center justify-center">
              <i class="fab fa-shopify text-green-500 text-3xl"></i>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white">Tienda Conectada</h3>
              <p class="text-gray-400">ofertasenmexico.com</p>
            </div>
            <span class="ml-auto status-pill bg-emerald-500/20 text-emerald-400">Activo</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
            <div class="p-4 bg-dark-700 rounded-xl">
              <p class="text-gray-400 text-sm">Productos Sincronizados</p>
              <p class="text-2xl font-bold text-white">156</p>
            </div>
            <div class="p-4 bg-dark-700 rounded-xl">
              <p class="text-gray-400 text-sm">Última Sincronización</p>
              <p class="text-2xl font-bold text-white">Hace 5 min</p>
            </div>
            <div class="p-4 bg-dark-700 rounded-xl">
              <p class="text-gray-400 text-sm">Webhooks Activos</p>
              <p class="text-2xl font-bold text-white">4</p>
            </div>
          </div>
        </div>
      </section>
      <section id="kommoSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Kommo CRM</h1>
          <p class="text-gray-400">Estado de la integración con Kommo</p>
        </div>
        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-center gap-4 mb-6">
            <div class="w-16 h-16 rounded-2xl bg-blue-500/10 flex items-center justify-center">
              <i class="fas fa-chart-line text-blue-500 text-3xl"></i>
            </div>
            <div>
              <h3 class="text-xl font-semibold text-white">CRM Conectado</h3>
              <p class="text-gray-400">cuenta.kommo.com</p>
            </div>
            <span class="ml-auto status-pill bg-emerald-500/20 text-emerald-400">Activo</span>
          </div>
          <div class="grid grid-cols-1 md:grid-cols-4 gap-4">
            <div class="p-4 bg-dark-700 rounded-xl">
              <p class="text-gray-400 text-sm">Leads Totales</p>
              <p class="text-2xl font-bold text-white">2,847</p>
            </div>
            <div class="p-4 bg-dark-700 rounded-xl">
              <p class="text-gray-400 text-sm">Etapas</p>
              <p class="text-2xl font-bold text-white">12</p>
            </div>
            <div class="p-4 bg-dark-700 rounded-xl">
              <p class="text-gray-400 text-sm">Usuarios</p>
              <p class="text-2xl font-bold text-white">8</p>
            </div>
          </div>
        </div>
      </section>
      <section id="blacklistSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Lista Negra</h1>
          <p class="text-gray-400">Usuarios reportados o bloqueados del sistema</p>
        </div>
        <div id="blacklistList" class="space-y-4">
          <!-- Populated by JS -->
        </div>
      </section>
      <section id="debtorsSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Gestión de Deudores</h1>
          <p class="text-gray-400">Clientes con pagos pendientes</p>
        </div>
        <div id="debtorsList" class="space-y-4">
          <!-- Populated by JS -->
        </div>
      </section>
      <section id="settingsSection" class="hidden p-4 lg:p-8 animate-fade-in">
        <div class="mb-8">
          <h1 class="text-3xl font-bold text-white mb-2">Configuración</h1>
          <p class="text-gray-400">Ajustes del sistema</p>
        </div>
        <div class="glass-card rounded-2xl p-6">
          <p class="text-gray-400">Sección en desarrollo...</p>
        </div>
      </section>
    </main>

    <!-- ORDER MODAL (Sin cambios) -->
    <div id="orderModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-overlay p-4">
      <div class="glass-strong rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-hidden animate-scale-in gradient-border">
        <div class="flex items-center justify-between px-8 py-5 border-b border-dark-600/50 bg-dark-850">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center">
              <i class="fas fa-receipt text-white"></i>
            </div>
            <div>
              <h3 id="modalTitle" class="text-xl font-bold text-white">Detalle de Orden</h3>
              <p class="text-sm text-gray-500">Información completa</p>
            </div>
          </div>
          <button onclick="closeOrderModal()" class="p-3 text-gray-400 hover:text-white bg-dark-700 rounded-xl transition-colors hover:bg-rose-500/20 hover:text-rose-500">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <div id="modalContent" class="p-8 overflow-y-auto max-h-[calc(90vh-100px)]">
        </div>
      </div>
    </div>

     <!-- Nuevo Modal para Acciones Rápidas (insertar después del modal de la orden) -->
    <div id="quickActionsModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-overlay p-4">
        <div class="glass-strong rounded-3xl w-full max-w-md animate-scale-in gradient-border">
            <div class="flex items-center justify-between px-8 py-5 border-b border-dark-600/50 bg-dark-850">
                <h3 class="text-xl font-bold text-white">Acciones Rápidas</h3>
                <button onclick="closeQuickActionsModal()"
                        class="p-3 text-gray-400 hover:text-white bg-dark-700 rounded-xl transition-colors hover:bg-rose-500/20 hover:text-rose-500">
                    <i class="fas fa-times text-lg"></i>
                </button>
            </div>
            <div class="p-6 space-y-4">
                <div class="glass-card rounded-2xl p-4">
                    <label class="block text-sm font-medium text-gray-300 mb-2">Motivo para crear Lead (obligatorio):</label>
                    <textarea id="leadReason" rows="3"
                              class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all"></textarea>
                    <button onclick="createLead()" class="btn-premium w-full text-white font-semibold py-3 rounded-xl mt-4 flex items-center justify-center gap-2">
                        <i class="fas fa-plus"></i>Crear Lead
                    </button>
                </div>
                <!-- Puedes añadir otras acciones aquí (Añadir a Drive, etc.) -->
            </div>
        </div>
    </div>

    <!-- CLIENT MODAL (Sin cambios) -->
    <div id="clientModal" class="fixed inset-0 z-50 hidden items-center justify-center modal-overlay p-4">
      <div class="glass-strong rounded-3xl w-full max-w-5xl max-h-[90vh] overflow-hidden animate-scale-in gradient-border">
        <div class="flex items-center justify-between px-8 py-5 border-b border-dark-600/50 bg-dark-850">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-accent-tertiary to-accent-secondary flex items-center justify-center">
              <i class="fas fa-user text-white"></i>
            </div>
            <div>
              <h3 id="clientModalTitle" class="text-xl font-bold text-white">Detalle de Cliente</h3>
              <p class="text-sm text-gray-500">Información completa y órdenes</p>
            </div>
          </div>
          <button onclick="closeClientModal()" class="p-3 text-gray-400 hover:text-white bg-dark-700 rounded-xl transition-colors hover:bg-rose-500/20 hover:text-rose-500">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        <div id="clientModalContent" class="p-8 overflow-y-auto max-h-[calc(90vh-100px)]">
          <!-- Populated by JS -->
        </div>
      </div>
    </div>

    <!-- COMMAND PALETTE (Sin cambios, para no romper otras funcionalidades) -->
    <div id="commandPalette" class="fixed inset-0 z-[60] hidden items-start justify-center pt-[15vh] modal-overlay">
      <div class="glass-strong rounded-2xl w-full max-w-2xl animate-slide-down overflow-hidden">
        <div class="p-4 border-b border-dark-600/50">
          <div class="flex items-center gap-3">
            <i class="fas fa-search text-gray-500"></i>
            <input type="text" id="commandInput" placeholder="Buscar órdenes, clientes, acciones..." 
              class="flex-1 bg-transparent text-white placeholder-gray-500 focus:outline-none text-lg"
              oninput="handleCommandSearch(this.value)">
            <kbd class="px-2 py-1 bg-dark-700 rounded text-xs text-gray-500">ESC</kbd>
          </div>
        </div>
        <div id="commandResults" class="max-h-[400px] overflow-y-auto p-2">
          <p class="text-gray-500 text-sm p-4 text-center">Escribe para buscar...</p>
        </div>
      </div>
    </div>

    <!-- SEARCH MODAL (NUEVO MODAL AÑADIDO) -->
    <div id="searchModal" class="fixed inset-0 z-[60] hidden items-center justify-center modal-overlay p-4">
      <div class="glass-strong rounded-3xl w-full max-w-4xl max-h-[90vh] overflow-y-auto animate-scale-in">
        <div class="flex items-center justify-between px-8 py-5 border-b border-dark-600/50 bg-dark-850">
          <div class="flex items-center gap-4">
            <div class="w-12 h-12 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center">
              <i class="fas fa-filter text-white"></i>
            </div>
            <div>
              <h3 class="text-xl font-bold text-white">Búsqueda Avanzada</h3>
              <p class="text-sm text-gray-500">Filtra órdenes usando múltiples criterios</p>
            </div>
          </div>
          <button onclick="closeSearchModal()" class="p-3 text-gray-400 hover:text-white bg-dark-700 rounded-xl transition-colors hover:bg-rose-500/20 hover:text-rose-500">
            <i class="fas fa-times text-lg"></i>
          </button>
        </div>
        
        <div class="p-8 space-y-6">
          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Número de Órden</label>
              <input type="text" id="searchOrderNumber" placeholder="Ej: #114880" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Nombre</label>
              <input type="text" id="searchPartialName" placeholder="Ej: juan" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Teléfono</label>
              <input type="text" id="searchPhone" placeholder="Ej: 5512345678" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Correo Electrónico</label>
              <input type="email" id="searchEmail" placeholder="Ej: cliente@correo.com" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Shopify Order ID</label>
              <input type="number" id="searchShopifyId" placeholder="Ej: 12345" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Shopify Customer ID</label>
              <input type="number" id="searchCustomerId" placeholder="Ej: 67890" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Calle</label>
              <input type="text" id="searchStreet" placeholder="Ej: Av. Insurgentes" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Ciudad</label>
              <input type="text" id="searchCity" placeholder="Ej: Ciudad de México" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Código Postal</label>
              <input type="text" id="searchPostalCode" placeholder="Ej: 01000" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Estado de Envío</label>
              <select id="searchStatus" class="w-full bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary">
                <option value="">Todos</option>
                <option value="4">En Espera</option>
                <option value="0">En Tránsito</option>
                <option value="1">Pronta Entrega</option>
                <option value="2">Entregado</option>
                <option value="3">Cancelado</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Estado de Pago</label>
              <select id="searchPaidStatus" class="w-full bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary">
                <option value="">Todos</option>
                <option value="advanced_paid">Pago Adelantado</option>
                <option value="pre_shipping">Pre-envío</option>
                <option value="pending">Pendiente</option>
                <option value="paid">Pagado</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Cobrador</label>
              <select id="searchCollector" class="w-full bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary">
                <option value="">Todos</option>
                <option value="co1">Cobrador 1</option>
                <option value="co2">Cobrador 2</option>
                <option value="co3">Cobrador 3</option>
                <option value="co4">Cobrador 4</option>
                <option value="co5">Cobrador 5</option>
                <option value="co6">Cobrador 6</option>
                <option value="co7">Cobrador 7</option>
                <option value="co8">Cobrador 8</option>
              </select>
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Confirmador</label>
              <select id="searchConfirmer" class="w-full bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary">
                <option value="">Todos</option>
                <option value="Confirmador 1">Confirmador 1</option>
                <option value="Confirmador 2">Confirmador 2</option>
              </select>
            </div>
          </div>

          <h3 class="text-center text-xl font-semibold text-gray-400 my-6">
            Fecha de Compra
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Fecha Exacta</label>
              <input type="date" id="searchDate" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all"
                pattern="\d{4}-\d{2}-\d{2}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Desde</label>
              <input type="date" id="searchDateFrom" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Hasta</label>
              <input type="date" id="searchDateTo" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
          </div>

          <h3 class="text-center text-xl font-semibold text-gray-400 my-6">
            Fecha de Confirmación
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Fecha Exacta</label>
              <input type="date" id="searchDateConfirmacion" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all"
                pattern="\d{4}-\d{2}-\d{2}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Desde</label>
              <input type="date" id="searchDateFromConfirmacion" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Hasta</label>
              <input type="date" id="searchDateToConfirmacion" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
          </div>

          <h3 class="text-center text-xl font-semibold text-gray-400 my-6">
            Fecha de Entrega
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Fecha Exacta</label>
              <input type="date" id="searchDateEntrega" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all"
                pattern="\d{4}-\d{2}-\d{2}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Desde</label>
              <input type="date" id="searchDateFromEntrega" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Hasta</label>
              <input type="date" id="searchDateToEntrega" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
          </div>

          <h3 class="text-center text-xl font-semibold text-gray-400 my-6">
            Fecha de Pago
          </h3>

          <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Fecha Exacta</label>
              <input type="date" id="searchDatePago" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all"
                pattern="\d{4}-\d{2}-\d{2}">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Desde</label>
              <input type="date" id="searchDateFromPago" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Hasta</label>
              <input type="date" id="searchDateToPago" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-300 focus:outline-none focus:border-accent-primary transition-all">
            </div>
          </div>

          <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Nombre del Producto</label>
              <input type="text" id="searchProduct" placeholder="Ej: Cartera RFID" 
                class="w-full bg-dark-800 border border-dark-600 rounded-xl py-3 px-4 text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary transition-all">
            </div>
            <div>
              <label class="block text-sm font-medium text-gray-300 mb-2">Origen de Compra</label>
              <select id="searchOrigin" class="w-full bg-dark-800 border border-dark-600 rounded-xl px-4 py-3 text-gray-300 text-sm focus:outline-none focus:border-accent-primary">
                <option value="">Todos</option>
                <option value="facebook">Facebook</option>
                <option value="instagram">Instagram</option>
                <option value="google">Google</option>
                <option value="direct">Directo</option>
              </select>
            </div>
          </div>

          <!-- Botón y Acción en el footer del modal de búsqueda -->
          <div class="flex items-center justify-between pt-6 border-t border-dark-600/50">
            <button onclick="closeSearchModal()" class="px-4 py-2.5 text-gray-400 hover:text-white bg-transparent rounded-xl hover:bg-dark-700/30 transition-colors">
              <i class="fas fa-times mr-2"></i>Cancelar
            </button>
            <div class="flex items-center gap-4">
              <button onclick="clearSearchFilters()" class="px-5 py-2.5 text-gray-400 hover:text-white bg-dark-700 rounded-xl hover:bg-dark-600 transition-colors">
                <i class="fas fa-undo mr-2"></i>Limpiar
              </button>
              <button onclick="performSearch()" class="btn-premium px-5 py-2.5 rounded-xl text-white font-medium">
                <i class="fas fa-search mr-2"></i>Aplicar Filtros
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
    <!-- /SEARCH MODAL -->

    <!-- Notifications Panel -->
    <div id="notificationsPanel" class="fixed top-16 right-4 z-50 hidden w-96 glass-strong rounded-2xl overflow-hidden animate-slide-down">
      <div class="px-5 py-4 border-b border-dark-600/50 flex items-center justify-between">
        <h4 class="font-semibold text-white">Notificaciones</h4>
        <button class="text-xs text-accent-primary hover:underline">Marcar todo leído</button>
      </div>
      <div class="max-h-[400px] overflow-y-auto p-3 space-y-2" id="notifPanelContent">
        <!-- Populated by JS -->
      </div>
    </div>

    <!-- AI Assistant Button -->
    <button onclick="toggleAIChat()" id="aiButton" class="fixed bottom-6 right-6 z-40 w-16 h-16 bg-gradient-to-r from-accent-primary via-accent-secondary to-accent-tertiary rounded-2xl shadow-lg flex items-center justify-center text-white hover:scale-110 transition-transform animate-bounce-subtle group">
      <i class="fas fa-robot text-2xl group-hover:scale-110 transition-transform"></i>
      <span class="absolute -top-1 -right-1 w-4 h-4 bg-emerald-500 rounded-full border-2 border-dark-900"></span>
    </button>

    <!-- AI Chat Panel -->
    <div id="aiChatPanel" class="fixed bottom-24 right-4 sm:right-6 z-40 hidden flex-col w-full sm:w-[380px] max-w-[calc(100vw-32px)] glass-strong rounded-2xl overflow-hidden animate-slide-up gradient-border">
      <div class="flex items-center justify-between px-5 py-4 bg-gradient-to-r from-accent-primary via-accent-secondary to-accent-tertiary">
        <div class="flex items-center gap-3">
          <div class="w-10 h-10 rounded-xl bg-white/20 flex items-center justify-center">
            <i class="fas fa-robot text-white"></i>
          </div>
          <div>
            <span class="font-semibold text-white">Asistente IA</span>
            <p class="text-xs text-white/70">Siempre disponible</p>
          </div>
        </div>
        <button onclick="toggleAIChat()" class="text-white/80 hover:text-white p-2 hover:bg-white/10 rounded-lg transition-colors">
          <i class="fas fa-times"></i>
        </button>
      </div>
      <div id="aiChatMessages" class="h-80 p-4 overflow-y-auto space-y-4 bg-dark-850">
        <div class="flex gap-3">
          <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center flex-shrink-0">
            <i class="fas fa-robot text-white text-sm"></i>
          </div>
          <div class="bg-dark-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
            <p class="text-sm text-gray-200">¡Hola! Soy tu asistente de ERP. Puedo ayudarte con:</p>
            <ul class="text-sm text-gray-400 mt-2 space-y-1">
              <li>• Buscar órdenes específicas</li>
              <li>• Generar reportes</li>
              <li>• Consultar métricas</li>
              <li>• Resolver dudas</li>
              <li>• Buscar fotos de la paquetería</li>
              <li>  - Para ello use el comando /get seguido del número de órden, ejemplo /get #12345</li>
            </ul>
          </div>
        </div>
      </div>
      <div class="p-4 border-t border-dark-600/50 bg-dark-850">
        <div class="flex gap-3">
          <input type="text" id="aiChatInput" placeholder="Escribe tu mensaje..." 
            class="flex-1 bg-dark-700 border border-dark-600 rounded-xl px-4 py-3 text-sm text-gray-200 placeholder-gray-500 focus:outline-none focus:border-accent-primary"
            onkeypress="if(event.key === 'Enter') sendAIMessage()">
          <button onclick="sendAIMessage()" class="w-12 h-12 bg-gradient-to-r from-accent-primary to-accent-secondary rounded-xl flex items-center justify-center text-white hover:opacity-90 transition-opacity">
            <i class="fas fa-paper-plane"></i>
          </button>
        </div>
      </div>
    </div>
  </div>

  <!-- ============================================= -->
  <!-- SCRIPT COMPLETO -->
  <!-- ============================================= -->
  <script>
    // =============================================
    // CONFIGURACIÓN API & ESTADO GLOBAL
    // =============================================
    const API_BASE_URL = "http://66.94.120.111:8000/api/v1";
    const LOGIN_API_URL = `${API_BASE_URL}/login`;
    const DASHBOARD_API_URL = `${API_BASE_URL}/dashboard`;
    const ORDERS_API_URL = `${API_BASE_URL}/orders`;
    const RECENT_ORDERS_API_URL = `${API_BASE_URL}/orders/recently`;
    const CLIENTS_API_URL = `${API_BASE_URL}/clients`;
    const SEARCH_API_URL = `${API_BASE_URL}/orders/search`;
    const ADD_TO_DRIVE_API_URL = "https://n8nerp.omexan.com/webhook/ca1cc6ff-6642-4a3c-a395-2d81456db595";

    // Estado global de los datos (ahora paginados)
    let ordersData = []; // Contendrá solo los items de la página actual
    let totalFilteredOrdersCount = 0; // Total de órdenes que coinciden con los filtros
    let currentPage = 1; // Página actual de órdenes
    const itemsPerPage = 10; // Órdenes por página

    let clientsData = []; // Contendrá solo los items de la página actual
    let totalFilteredClientsCount = 0; // Total de clientes que coinciden con los filtros
    let currentClientPage = 1; // Página actual de clientes
    const clientsPerPage = 10; // Clientes por página
    
    // Contadores globales para los badges de la sidebar (se cargan al inicio)
    let totalOrdersGlobal = 0;
    let totalClientsGlobal = 0;

    let dashboardMetrics = null;
    let recentOrdersDashboard = [];
    let searchResultsData = []; // Variable global para almacenar los resultados de la búsqueda

    let currentUser = null;
    let currentSection = 'dashboard';
    let allProductSplashIntervals = [];

    const STATUS_MAP = {
      0: { label: 'En Tránsito', class: 'bg-amber-500/20 text-amber-400', icon: 'fa-truck', color: 'amber-400', bg: 'bg-amber-500/20' },
      1: { label: 'Pronta Entrega', class: 'bg-cyan-500/20 text-cyan-400', icon: 'fa-box-open', color: 'cyan-400', bg: 'bg-cyan-500/20' },
      2: { label: 'Entregado', class: 'bg-emerald-500/20 text-emerald-400', icon: 'fa-check-circle', color: 'emerald-400', bg: 'bg-emerald-500/20' },
      3: { label: 'Cancelado', class: 'bg-rose-500/20 text-rose-400', icon: 'fa-times-circle', color: 'rose-400', bg: 'bg-rose-500/20' },
      4: { label: 'En Espera', class: 'bg-sky-500/20 text-sky-400', icon: 'fa-hourglass-half', color: 'sky-400', bg: 'bg-sky-500/20' }
    };
    
    const PAYMENT_STATUS_MAP = {
      'paid': { label: 'Pagado', class: 'bg-emerald-500/20 text-emerald-400', icon: 'fa-check-circle', color: 'emerald-400', bg: 'bg-emerald-500/20' },
      'pending': { label: 'Pendiente', class: 'bg-amber-500/20 text-amber-400', icon: 'fa-clock', color: 'amber-400', bg: 'bg-amber-500/20' },
      'advanced_paid': { label: 'Pago Adelantado', class: 'bg-blue-500/20 text-blue-400', icon: 'fa-hand-holding-dollar', color: 'blue-400', bg: 'bg-blue-500/20' },
      'pre_shipping': { label: 'Pre-envío', class: 'bg-cyan-500/20 text-cyan-400', icon: 'fa-hourglass-start', color: 'cyan-400', bg: 'bg-cyan-500/20' },
      'wait': { label: 'Pendiente', class: 'bg-amber-500/20 text-amber-400', icon: 'fa-clock', color: 'amber-400', bg: 'bg-amber-500/20' },
      'partial': { label: 'Pago parcial', class: 'bg-blue-500/20 text-blue-400', icon: 'fa-percentage', color: 'blue-400', bg: 'bg-blue-500/20' },
      'failed': { label: 'Fallido', class: 'bg-rose-500/20 text-rose-400', icon: 'fa-exclamation-triangle', color: 'rose-400', bg: 'bg-rose-500/20' }
    };

    // =============================================
    // INICIALIZACIÓN
    // =============================================
    document.addEventListener('DOMContentLoaded', () => {
      initKeyboardShortcuts();
      initCharts();
      const savedUser = localStorage.getItem('erpUser');
      if (savedUser) {
        currentUser = JSON.parse(savedUser);
        showMainApp();
      }
    });

    // =============================================
    // FUNCIONES DE BÚSQUEDA AVANZADA (NUEVAS)
    // =============================================
    
    function showPipelineDetails(element) {
      const modal = element.closest('#orderModal');
      if (!modal) {
        console.error("No se encontró el modal padre");
        return;
      }

      const pipelineDetailsContainer = modal.querySelector('#pipelineDetailsContainer');
      const pipelineArrow = element.querySelector('#pipelineArrow');
      const rawPipelineStages = JSON.parse(element.dataset.pipelineStages || '[]');

      if (!rawPipelineStages || rawPipelineStages.length === 0) {
        console.warn("No hay etapas de pipeline para mostrar.");
        return;
      }

      if (pipelineDetailsContainer.classList.contains('hidden')) {
        // Renderiza los detalles
        pipelineDetailsContainer.innerHTML = `
          <ul class="space-y-1 text-sm bg-dark-800 p-3 rounded-lg border border-dark-600/50 animate-slide-up">
            ${rawPipelineStages.map(stage => {
              const pipelineName = stage?.pipeline || 'Desconocido';
              const statusName = stage?.status || 'Desconocido';
              return `
                <li class="flex items-center gap-2">
                  <i class="fas fa-circle text-accent-secondary text-[6px]"></i>
                  <span class="font-medium text-white">${pipelineName}</span>
                  <span class="text-gray-400">- ${statusName}</span>
                </li>
              `;
            }).join('')}
          </ul>
        `;
        pipelineDetailsContainer.classList.remove('hidden');
        if (pipelineArrow) {
          pipelineArrow.classList.add('rotate-180');
        }
      } else {
        // Oculta los detalles
        pipelineDetailsContainer.classList.add('hidden');
        pipelineDetailsContainer.innerHTML = '';
        if (pipelineArrow) {
          pipelineArrow.classList.remove('rotate-180');
        }
      }
    }
    
    function openSearchModal() {
      document.getElementById('searchModal').classList.remove('hidden');
      document.getElementById('searchModal').classList.add('flex');
    }

    function closeSearchModal() {
      document.getElementById('searchModal').classList.add('hidden');
      document.getElementById('searchModal').classList.remove('flex');
    }

    function clearSearchFilters() {
      const inputs = document.querySelectorAll('#searchModal input');
      const selects = document.querySelectorAll('#searchModal select');
      inputs.forEach(input => input.value = '');
      selects.forEach(select => select.value = '');
    }

    async function performSearch() {
      showLoading();

      // 1. Crear un objeto JavaScript con los filtros
      const searchPayload = {
        order_number: document.getElementById('searchOrderNumber').value || null,
        partialName: document.getElementById('searchPartialName').value || null,
        phone: document.getElementById('searchPhone').value || null,
        email: document.getElementById('searchEmail').value || null,
        shopifyId: document.getElementById('searchShopifyId').value ? parseInt(document.getElementById('searchShopifyId').value) : null,
        customerId: document.getElementById('searchCustomerId').value ? parseInt(document.getElementById('searchCustomerId').value) : null,
        street: document.getElementById('searchStreet').value || null,
        city: document.getElementById('searchCity').value || null,
        postalCode: document.getElementById('searchPostalCode').value || null,
        collectorName: document.getElementById('searchCollector').value || null,
        confirmerName: document.getElementById('searchConfirmer').value || null,
        origin: document.getElementById('searchOrigin').value || null,
        status: document.getElementById('searchStatus').value ? parseInt(document.getElementById('searchStatus').value) : null,
        paidStatus: document.getElementById('searchPaidStatus').value || null,
        product: document.getElementById('searchProduct').value || null,
        date: document.getElementById('searchDate').value || null,
        dateFrom: document.getElementById('searchDateFrom').value || null,
        dateTo: document.getElementById('searchDateTo').value || null,
        dateConfirmacion: document.getElementById('searchDateConfirmacion').value || null,
        dateFromConfirmacion: document.getElementById('searchDateFromConfirmacion').value || null,
        dateToConfirmacion: document.getElementById('searchDateToConfirmacion').value || null,
        dateEntrega: document.getElementById('searchDateEntrega').value || null,
        dateFromEntrega: document.getElementById('searchDateFromEntrega').value || null,
        dateToEntrega: document.getElementById('searchDateToEntrega').value || null,
        datePago: document.getElementById('searchDatePago').value || null,
        dateFromPago: document.getElementById('searchDateFromPago').value || null,
        dateToPago: document.getElementById('searchDateToPago').value || null,
      };
      
      // Elimina las propiedades que son null o undefined para no enviar basura
      Object.keys(searchPayload).forEach(key => {
        if (searchPayload[key] === null || searchPayload[key] === undefined) {
          delete searchPayload[key];
        }
      });

      try {
        // 2. Usar fetch con el método POST y enviar el cuerpo (body) como JSON
        const response = await fetch(SEARCH_API_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
          },
          body: JSON.stringify(searchPayload),
        });
        
        if (!response.ok) {
          // Maneja los errores de la API, como 422 (Validación) o 500
          let errorMessage = "Hubo un error al realizar la búsqueda.";
          try {
            const contentType = response.headers.get("content-type");
            if (contentType && contentType.includes("application/json")) {
              const errorData = await response.json();
              // Si el backend devuelve detalles, úsalos
              if (errorData.detail && Array.isArray(errorData.detail)) {
                errorMessage = errorData.detail.map(d => `${d.loc[1]}: ${d.msg}`).join(", ");
              } else {
                errorMessage = errorData.detail || errorMessage;
              }
            }
          } catch (e) {
            // Si no se puede parsear el error, usa el status
          }
          throw new Error(errorMessage);
        }

        const results = await response.json();
        
        closeSearchModal();
        hideLoading();
        showSearchResults(results);

      } catch (error) {
        console.error('Search failed:', error);
        hideLoading();
        // Muestra una notificación más limpia, quizás reutilizando tu 'ephemeralNotification'
        const notification = document.getElementById('ephemeralNotification');
        const messageEl = document.getElementById('notificationMessage');
        messageEl.textContent = `Hubo un error al realizar la búsqueda: ${error.message}`;
        
        // Forzar a que sea roja y se muestre
        notification.classList.remove('hidden', '-translate-y-full', 'opacity-0');
        notification.classList.add('translate-y-0', 'opacity-100');

        setTimeout(() => {
            // Animar la salida
            notification.classList.remove('translate-y-0', 'opacity-100');
            notification.classList.add('-translate-y-full', 'opacity-0');
            setTimeout(() => { notification.classList.add('hidden'); }, 500);
        }, 4000);
      }
    }

    function showSearchResults(orders) {
      document.querySelectorAll('main > section, #resultsSection').forEach(s => s.classList.add('hidden'));
      document.getElementById('resultsSection').classList.remove('hidden');
      
      document.getElementById('resultsCount').textContent = orders.length;
      
      const container = document.getElementById('searchResultsTableBody');
      
      if (!orders || orders.length === 0) {
          container.innerHTML = '<tr><td colspan="6" class="p-4 text-center text-gray-500">No se encontraron órdenes con los criterios especificados.</td></tr>';
      } else {
          container.innerHTML = orders.map(order => `
            <tr class="table-row-hover cursor-pointer hover:bg-dark-700/50 transition-colors border-b border-dark-600/30" onclick="openOrderModal('${order.id}')">
              <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="font-bold text-white">${order.kommo_order_number}</span>
                    <span class="text-xs text-gray-500 mt-1">Orden #${order.id}</span>
                  </div>
              </td>
              <td class="px-6 py-4">
                  <div class="flex flex-col">
                    <span class="font-semibold text-white">${order.customerName}</span>
                    <span class="text-xs text-gray-500 mt-1">${order.contactInfo?.email || 'N/A'}</span>
                  </div>
              </td>
              <td class="px-6 py-4">
                  <span class="font-bold text-white text-lg">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
              </td>
              <td class="px-6 py-4">
                  <div class="flex items-center gap-1">
                      <i class="fas ${PAYMENT_STATUS_MAP[order.paid_status]?.icon || 'fa-clock'} text-${PAYMENT_STATUS_MAP[order.paid_status]?.color || 'amber-400'}"></i>
                      <span class="text-sm font-medium">${PAYMENT_STATUS_MAP[order.paid_status]?.label || 'Desconocido'}</span>
                  </div>
              </td>
              <td class="px-6 py-4">
                  <div class="flex items-center gap-1">
                      <i class="fas ${STATUS_MAP[order.status]?.icon || 'fa-truck'} text-${STATUS_MAP[order.status]?.color || 'amber-400'}"></i>
                      <span class="text-sm font-medium">${STATUS_MAP[order.status]?.label || 'Desconocido'}</span>
                  </div>
              </td>
              <td class="px-6 py-4">
                  <span class="text-sm text-gray-300">${order.fecha_compra}</span>
              </td>
            </tr>
          `).join('');
      }
    }

    function goBackToDashboard() {
      document.getElementById('resultsSection').classList.add('hidden');
      searchResultsData = [];
      showSection('dashboard');
    }
    
    // =============================================
    // AUTH & NAVIGATION
    // =============================================
    function initKeyboardShortcuts() {
      document.addEventListener('keydown', (e) => {
        if ((e.metaKey || e.ctrlKey) && e.key === 'k') {
          e.preventDefault();
          openSearchModal();
        }
        if (e.key === 'Escape') {
          closeSearchModal();
          closeOrderModal();
          const notificationsPanel = document.getElementById('notificationsPanel');
          if (!notificationsPanel.classList.contains('hidden')) {
              notificationsPanel.classList.add('hidden');
          }
          const aiChatPanel = document.getElementById('aiChatPanel');
          if (!aiChatPanel.classList.contains('hidden')) {
              aiChatPanel.classList.add('hidden');
          }
          closeEphemeralNotification(); 
        }
      });
    }

    document.getElementById('loginForm').addEventListener('submit', async function(e) {
        e.preventDefault();
        const email = document.getElementById('loginEmail').value;
        const password = document.getElementById('loginPassword').value;
        const errorEl = document.getElementById('loginError');
        errorEl.classList.add('hidden'); 
        errorEl.textContent = '';
        const submitButton = e.submitter;
        submitButton.disabled = true;
        submitButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Cargando...';
        try {
            const response = await fetch(LOGIN_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ email, password })
            });
            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Credenciales inválidas');
            }
            const userData = await response.json();
            currentUser = { 
                email: userData.email, 
                name: userData.name, 
                role: userData.role 
            };
            localStorage.setItem('erpUser', JSON.stringify(currentUser));
            showMainApp();
        } catch (error) {
            console.error('Login failed:', error);
            errorEl.textContent = error.message || 'Error al conectar con el servidor.';
            errorEl.classList.remove('hidden');
        } finally {
          submitButton.disabled = false;
          submitButton.innerHTML = '<span>Iniciar Sesión</span><i class="fas fa-arrow-right"></i>';
        }
    });

    function togglePasswordVisibility() {
        const input = document.getElementById('loginPassword');
        const icon = document.getElementById('passwordIcon');
        if (input.type === 'password') {
            input.type = 'text';
            icon.className = 'fas fa-eye-slash';
        } else {
            input.type = 'password';
            icon.className = 'fas fa-eye';
        }
    }

    function logout() {
        localStorage.removeItem('erpUser');
        currentUser = null;
        document.getElementById('loginScreen').classList.remove('hidden');
        document.getElementById('mainApp').classList.add('hidden');
        hideLoading();
    }

    async function showMainApp() {
        document.getElementById('loginScreen').classList.add('hidden');
        document.getElementById('mainApp').classList.remove('hidden');
        showLoading();
        try {
            // Carga solo los datos del dashboard y órdenes recientes
            await fetchDashboardData();
            await fetchRecentOrdersData();
            // Carga los contadores totales para los badges de la sidebar
            await fetchAndSetGlobalCounts(); // Nueva función para cargar solo los contadores

            // Asegúrate de que la sección activa se renderice con datos (paginados)
            // Por defecto será 'dashboard', que no necesita ordersData o clientsData completos.
            showSection(currentSection);

            document.getElementById('userName').textContent = currentUser.name;
            document.getElementById('welcomeName').textContent = currentUser.name;
            document.getElementById('userRole').innerHTML = `<span class="w-1.5 h-1.5 bg-accent-primary rounded-full"></span> ${getRoleName(currentUser.role)}`;
            document.getElementById('userInitial').textContent = currentUser.name.charAt(0).toUpperCase();
        } catch (error) {
            console.error("Error al cargar datos iniciales:", error);
            alert("Hubo un error al cargar los datos iniciales. Por favor, revisa la consola o intenta de nuevo.");
            logout();
        } finally {
            hideLoading();
        }
    }

    function getRoleName(role) {
        const roles = {
            admin: 'Administrador',
            confirmador: 'Confirmador',
            cobrador: 'Cobrador',
            logistica: 'Logística'
        };
        return roles[role] || role;
    }

    // Nueva función para obtener solo los contadores totales
    async function fetchAndSetGlobalCounts() {
        try {
            // Obtenemos un conteo total de órdenes (podría ser una llamada a /orders con page_size=1)
            const ordersResponse = await fetch(`${ORDERS_API_URL}?page=1&page_size=1`);
            if (ordersResponse.ok) {
                const ordersDataResponse = await ordersResponse.json();
                totalOrdersGlobal = ordersDataResponse.total_count;
                document.getElementById('ordersCountBadge').textContent = totalOrdersGlobal;
            } else {
                console.error('Error fetching total orders count');
            }

            // Obtenemos un conteo total de clientes (podría ser una llamada a /clients con page_size=1)
            const clientsResponse = await fetch(`${CLIENTS_API_URL}?page=1&page_size=1`);
            if (clientsResponse.ok) {
                const clientsDataResponse = await clientsResponse.json();
                totalClientsGlobal = clientsDataResponse.total_count;
                document.getElementById('clientsCountBadge').textContent = totalClientsGlobal;
            } else {
                console.error('Error fetching total clients count');
            }

        } catch (error) {
            console.error('Error fetching global counts:', error);
        }
    }

    function showSection(section) {
        currentSection = section;
        document.querySelectorAll('main > section, #resultsSection').forEach(s => s.classList.add('hidden'));
        const sectionElement = document.getElementById(`${section}Section`);
        if (sectionElement) sectionElement.classList.remove('hidden');
        document.querySelectorAll('.nav-link').forEach(link => {
            link.classList.remove('active');
            // Asegúrate de que el data-section del link sea el correcto, o ajusta la condición
            const linkSection = link.getAttribute('onclick')?.match(/showSection\('([^']*)'\)/)?.[1];
            if (linkSection === section) {
                link.classList.add('active');
            }
        });

        // Cargar datos solo cuando la sección se vuelve visible
        if (section === 'dashboard') {
            renderRecentOrders(); // Ya tiene sus propios datos precargados
        } else if (section === 'orders') {
            fetchOrdersData(currentPage, {
                search: document.getElementById('orderSearch')?.value || '',
                payment: document.getElementById('filterPayment')?.value || '',
                origin: document.getElementById('filterOrigin')?.value || ''
            });
        } else if (section === 'clients') { // Corregido a 'clients'
            fetchClientsData(currentClientPage, {
                search: document.getElementById('clientSearch')?.value || '',
                clientType: document.getElementById('filterClientType')?.value || ''
            });
        } else if (section === 'acciones') {
            const orderId = sessionStorage.getItem('currentOrderId');
            const kommoOrderNumber = sessionStorage.getItem('currentKommoOrderNumber');
            const accionesSubtitle = document.getElementById('accionesSubtitle');
            if (accionesSubtitle && kommoOrderNumber) {
                accionesSubtitle.innerHTML = `Elige una acción para realizar con la orden: <span class="text-accent-primary font-semibold">${kommoOrderNumber}</span>`;
            } else if (accionesSubtitle) {
                accionesSubtitle.textContent = `Elige una acción para realizar. (No hay orden seleccionada)`;
            }
            // Asegurarse de ocultar el formulario de lead al cambiar de sección
            document.getElementById('createLeadForm').classList.add('hidden');
        }
    }

    function showCreateLeadForm() {
        const form = document.getElementById('createLeadForm');
        const actions = document.getElementById('accionesSection');
        if (form) {
            form.classList.remove('hidden');
             form.scrollIntoView({ behavior: 'smooth' }); 
        }
    }

    function toggleSidebar() {
      document.getElementById('sidebar').classList.toggle('-translate-x-full');
    }

    // =============================================
    // API FUNCTIONS
    // =============================================
    async function fetchDashboardData() {
        try {
            const response = await fetch(DASHBOARD_API_URL);
            if (!response.ok) { throw new Error(`Error ${response.status}: No se pudieron cargar las métricas.`); }
            dashboardMetrics = await response.json();
            updateDashboardMetrics();
            return dashboardMetrics;
        } catch (error) { console.error('Error fetching dashboard data:', error); return null; }
    }

    async function fetchRecentOrdersData() {
        try {
            const response = await fetch(RECENT_ORDERS_API_URL);
            if (!response.ok) { throw new Error(`Error ${response.status}: No se pudieron cargar las órdenes recientes.`); }
            recentOrdersDashboard = await response.json();
            return recentOrdersDashboard;
        } catch (error) { console.error('Error fetching recent orders for dashboard:', error); return []; }
    }

    async function fetchClientsData(page = 1, filters = {}) {
        showLoading();
        const queryParams = new URLSearchParams({
            page: page,
            page_size: clientsPerPage,
            search: filters.search || '',
            client_type: filters.clientType || ''
        }).toString();

        try {
            const response = await fetch(`${CLIENTS_API_URL}?${queryParams}`);
            if (!response.ok) { throw new Error(`Error ${response.status}: No se pudieron cargar los clientes.`); }
            const data = await response.json();
            clientsData = data.items.map(client => ({
                id: client.id, name: client.name, email: client.email, phone: client.phone,
                totalSpent: client.totalSpent, orderCount: client.orderCount, userType: client.userType,
                lastOrderDate: client.lastOrderDate, orders: client.orders || []
            }));
            totalFilteredClientsCount = data.total_count; // Actualiza el total global de clientes filtrados
            currentClientPage = data.page; // Sincroniza la página actual con la que respondió el backend
            renderClientsTable(); // Vuelve a renderizar la tabla con los nuevos datos
            document.getElementById('totalClientsCount').textContent = totalFilteredClientsCount; // Actualiza el contador total visible
        } catch (error) {
            console.error('Error fetching clients:', error);
            clientsData = []; // Limpia los datos en caso de error
            totalFilteredClientsCount = 0;
            renderClientsTable();
        } finally {
            hideLoading();
        }
    }

    async function fetchOrdersData(page = 1, filters = {}) {
        showLoading();
        const queryParams = new URLSearchParams({
            page: page,
            page_size: itemsPerPage,
            search: filters.search || '',
            payment_status: filters.payment || '',
            origin: filters.origin || ''
        }).toString();

        try {
            const response = await fetch(`${ORDERS_API_URL}?${queryParams}`);
            if (!response.ok) { throw new Error(`Error ${response.status}: No se pudieron cargar las órdenes.`); }
            const data = await response.json();
            ordersData = data.items.map(order => ({
                id: order.id, kommo_order_number: order.kommo_order_number, status: order.status,
                paidStatus: order.paid_status, total: order.total, date: order.fecha_compra,
                customerName: order.customerName, origen_compra: order.origen_compra,
                contactInfo: order.contactInfo, products: []
            }));
            totalFilteredOrdersCount = data.total_count; // Actualiza el total global de órdenes filtradas
            currentPage = data.page; // Sincroniza la página actual con la que respondió el backend
            renderOrdersTable(); // Vuelve a renderizar la tabla con los nuevos datos
            document.getElementById('totalOrdersCount').textContent = totalFilteredOrdersCount; // Actualiza el contador total visible
        } catch (error) {
            console.error('Error fetching orders:', error);
            ordersData = []; // Limpia los datos en caso de error
            totalFilteredOrdersCount = 0;
            renderOrdersTable();
        } finally {
            hideLoading();
        }
    }
    
    function updateDashboardMetrics() {
        if (!dashboardMetrics) return;
        document.getElementById('totalOrders').textContent = dashboardMetrics.totalOrders.toLocaleString();
        document.getElementById('revenue').textContent = `$${(dashboardMetrics.revenue).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
        document.getElementById('unconfirmedOrders').textContent = dashboardMetrics.unconfirmedOrders.toLocaleString();
        document.getElementById('confirmedOrders').textContent = dashboardMetrics.confirmedOrders.toLocaleString();
        document.getElementById('inTransitAndSoon').textContent = dashboardMetrics.inTransitAndSoon.toLocaleString();
        document.getElementById('deliveredAndPaid').textContent = dashboardMetrics.deliveredAndPaid.toLocaleString();
        document.getElementById('deliveredAndUnpaid').textContent = dashboardMetrics.deliveredAndUnpaid.toLocaleString();
        document.getElementById('canceledOrders').textContent = dashboardMetrics.canceledOrders.toLocaleString();
        document.getElementById('averageOrderValue').textContent = `$${(dashboardMetrics.averageOrderValue).toLocaleString(undefined, { minimumFractionDigits: 2, maximumFractionDigits: 2 })}`;
    }

    // =============================================
    // RENDER FUNCTIONS
    // =============================================
    function renderRecentOrders() {
      const container = document.getElementById('recentOrdersList');
      if (!recentOrdersDashboard || recentOrdersDashboard.length === 0) {
        container.innerHTML = '<div class="p-6 text-gray-500 text-center">No hay órdenes recientes</div>';
        return;
      }
      container.innerHTML = recentOrdersDashboard.map(order => `
        <div class="glass-card p-5 rounded-xl hover-glow cursor-pointer transition-all duration-300 hover:scale-[1.01] border border-dark-600/50" onclick="openOrderModal('${order.id}')">
          <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-4">
            <div class="flex items-start gap-4">
              <div class="w-14 h-14 rounded-xl bg-gradient-to-br from-blue-500/20 to-purple-500/20 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-box text-blue-400 text-xl"></i>
              </div>
              <div>
                <div class="flex items-baseline gap-2">
                  <p class="font-bold text-white text-lg">${order.kommo_order_number}</p>
                  <span class="text-xs font-medium px-2 py-0.5 rounded-full bg-dark-700 text-blue-300">${order.id}</span>
                </div>
                <p class="text-sm text-gray-400 mt-1">${order.customerName}</p>
              </div>
            </div>
            <div class="flex flex-col sm:items-end gap-3 min-w-[180px]">
              <div class="text-right">
                <p class="font-bold text-white text-lg">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                <p class="text-xs text-gray-500 mt-0.5">Monto total</p>
              </div>
              <div class="flex items-center justify-between w-full">
                <div class="flex flex-col items-start">${getPaymentIcon(order.paidStatus)}</div>
                <div class="flex flex-col items-end">${getStatusIcon(order.status)}</div>
              </div>
            </div>
          </div>
        </div>
      `).join('');
    }

    function getStatusIcon(status) {
      const config = STATUS_MAP[status] || STATUS_MAP[0];
      return `
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center ${config.bg}">
            <i class="fas ${config.icon} text-${config.color}"></i>
          </div>
          <span class="text-sm font-medium">${config.label}</span>
        </div>
      `;
    }
    
    function getPaymentIcon(status) {
      const config = PAYMENT_STATUS_MAP[status] || PAYMENT_STATUS_MAP['wait'];
      return `
        <div class="flex items-center gap-2">
          <div class="w-8 h-8 rounded-lg flex items-center justify-center ${config.bg}">
            <i class="fas ${config.icon} text-${config.color}"></i>
          </div>
          <span class="text-sm font-medium">${config.label}</span>
        </div>
      `;
    }

    function renderClientsTable() {
        const container = document.getElementById('clientsTableBody');
        const clientsToDisplay = clientsData; // Ahora clientsData ya contiene solo los items de la página actual

        if (!clientsToDisplay || clientsToDisplay.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No se encontraron clientes</td></tr>';
            document.getElementById('clientsShowing').textContent = '0';
        } else {
            const startIndex = (currentClientPage - 1) * clientsPerPage;
            const endIndex = startIndex + clientsToDisplay.length; // Usa la longitud de clientsToDisplay

            container.innerHTML = clientsToDisplay.map(client => `
                <tr class="table-row-hover cursor-pointer hover:bg-dark-700/50 transition-colors border-b border-dark-600/30" onclick="openClientModal('${client.id}')">
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-bold text-white">${client.name}</span>
                            <span class="text-xs text-gray-500 mt-1">${client.email}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-bold text-white">${client.phone || 'N/A'}</span>
                            <span class="text-xs text-gray-500 mt-1 capitalize">${client.userType || 'cliente'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-white text-lg">$${client.totalSpent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                    </td>
                    <td class="px-6 py-4">
                        <span class="font-bold text-white">${client.orderCount}</span>
                    </td>
                </tr>
            `).join('');
            document.getElementById('clientsShowing').textContent = `${totalFilteredClientsCount === 0 ? 0 : startIndex + 1}-${endIndex > totalFilteredClientsCount ? totalFilteredClientsCount : endIndex}`;
        }
        document.getElementById('totalClientsCount').textContent = totalFilteredClientsCount;
        renderClientsPaginationControls();
    }

    function renderClientsPaginationControls() {
        const paginationContainer = document.getElementById('clientsPaginationControls');
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(totalFilteredClientsCount / clientsPerPage);

        const prevButton = document.createElement('button');
        prevButton.className = 'p-2 text-gray-500 hover:text-white bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors flex items-center justify-center';
        if (currentClientPage === 1) {
            prevButton.className = 'p-2 text-dark-500 bg-dark-800 cursor-not-allowed rounded-lg flex items-center justify-center';
        }
        prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevButton.disabled = currentClientPage === 1;
        prevButton.onclick = (event) => { if (!prevButton.disabled) { event.stopPropagation(); changeClientPage(currentClientPage - 1); } };
        paginationContainer.appendChild(prevButton);

        const maxVisibleButtons = 5;
        let startPage = Math.max(1, currentClientPage - Math.floor(maxVisibleButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxVisibleButtons - 1);
        if (endPage - startPage + 1 < maxVisibleButtons) {
            startPage = Math.max(1, endPage - maxVisibleButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            if (i === currentClientPage) {
                pageButton.className = 'px-3 py-1.5 bg-accent-primary text-white font-medium rounded-lg text-sm';
            } else {
                pageButton.className = 'px-3 py-1.5 text-gray-400 hover:text-white bg-dark-700 hover:bg-dark-600 rounded-lg text-sm';
            }
            pageButton.textContent = i;
            pageButton.onclick = (event) => { event.stopPropagation(); changeClientPage(i); };
            paginationContainer.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.className = 'p-2 text-gray-500 hover:text-white bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors flex items-center justify-center';
        if (currentClientPage === totalPages || totalPages === 0) {
            nextButton.className = 'p-2 text-dark-500 bg-dark-800 cursor-not-allowed rounded-lg flex items-center justify-center';
        }
        nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextButton.disabled = currentClientPage === totalPages || totalPages === 0;
        nextButton.onclick = (event) => { if (!nextButton.disabled) { event.stopPropagation(); changeClientPage(currentClientPage + 1); } };
        paginationContainer.appendChild(nextButton);
    }

    function changeClientPage(page) {
        const totalPages = Math.ceil(totalFilteredClientsCount / clientsPerPage); // Usa totalFilteredClientsCount
        if (page >= 1 && page <= totalPages) {
            currentClientPage = page;
            const search = document.getElementById('clientSearch')?.value || '';
            const clientType = document.getElementById('filterClientType')?.value || '';
            fetchClientsData(currentClientPage, { search, clientType });
        }
    }

    function filterClients() {
        currentClientPage = 1; // Siempre vuelve a la primera página al aplicar nuevos filtros
        const search = document.getElementById('clientSearch')?.value || '';
        const clientType = document.getElementById('filterClientType')?.value || '';
        fetchClientsData(currentClientPage, { search, clientType });
    }

    function clearClientFilters() {
        document.getElementById('clientSearch').value = '';
        document.getElementById('filterClientType').value = '';
        fetchClientsData(1, {}); // Llama a fetchClientsData sin filtros para reiniciar la tabla
    }

    function renderOrdersTable() {
        const container = document.getElementById('ordersTableBody');
        const ordersToDisplay = ordersData; // Ahora ordersData ya contiene solo los items de la página actual

        if (!ordersToDisplay || ordersToDisplay.length === 0) {
            container.innerHTML = '<tr><td colspan="4" class="p-4 text-center text-gray-500">No se encontraron órdenes</td></tr>';
            document.getElementById('ordersShowing').textContent = '0';
        } else {
            const startIndex = (currentPage - 1) * itemsPerPage;
            const endIndex = startIndex + ordersToDisplay.length; // Usa la longitud de ordersToDisplay

            container.innerHTML = ordersToDisplay.map(order => `
                <tr class="table-row-hover cursor-pointer hover:bg-dark-700/50 transition-colors border-b border-dark-600/30" onclick="openOrderModal('${order.id}')">
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-bold text-white">${order.kommo_order_number}</span>
                            <span class="text-xs text-gray-500 mt-1">Orden #${order.id}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex flex-col">
                            <span class="font-bold text-white text-lg">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            <span class="text-xs text-gray-500 mt-1">${formatDate(order.date)}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            <i class="fas ${PAYMENT_STATUS_MAP[order.paidStatus]?.icon || 'fa-clock'} text-${PAYMENT_STATUS_MAP[order.paidStatus]?.color || 'amber-400'}"></i>
                            <span class="text-sm font-medium">${PAYMENT_STATUS_MAP[order.paidStatus]?.label || 'Desconocido'}</span>
                        </div>
                    </td>
                    <td class="px-6 py-4">
                        <div class="flex items-center gap-1">
                            <i class="fas ${STATUS_MAP[order.status]?.icon || 'fa-truck'} text-${STATUS_MAP[order.status]?.color || 'amber-400'}"></i>
                            <span class="text-sm font-medium">${STATUS_MAP[order.status]?.label || 'Desconocido'}</span>
                        </div>
                    </td>
                </tr>
            `).join('');
            document.getElementById('ordersShowing').textContent = `${totalFilteredOrdersCount === 0 ? 0 : startIndex + 1}-${endIndex > totalFilteredOrdersCount ? totalFilteredOrdersCount : endIndex}`;
        }
        document.getElementById('totalOrdersCount').textContent = totalFilteredOrdersCount;
        renderPaginationControls();
    }
    
    function renderPaginationControls() {
        const paginationContainer = document.querySelector('#ordersSection .flex.items-center.gap-2');
        paginationContainer.innerHTML = '';
        const totalPages = Math.ceil(totalFilteredOrdersCount / itemsPerPage);

        const prevButton = document.createElement('button');
        prevButton.className = 'p-2 text-gray-500 hover:text-white bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors flex items-center justify-center';
        if (currentPage === 1) { 
            prevButton.className = 'p-2 text-dark-500 bg-dark-800 cursor-not-allowed rounded-lg flex items-center justify-center';
        }
        prevButton.innerHTML = '<i class="fas fa-chevron-left"></i>';
        prevButton.disabled = currentPage === 1;
        prevButton.onclick = (event) => { if (!prevButton.disabled) { event.stopPropagation(); changePage(currentPage - 1); } };
        paginationContainer.appendChild(prevButton);

        const maxVisibleButtons = 5;
        let startPage = Math.max(1, currentPage - Math.floor(maxVisibleButtons / 2));
        let endPage = Math.min(totalPages, startPage + maxVisibleButtons - 1);
        if (endPage - startPage + 1 < maxVisibleButtons) {
            startPage = Math.max(1, endPage - maxVisibleButtons + 1);
        }

        for (let i = startPage; i <= endPage; i++) {
            const pageButton = document.createElement('button');
            if (i === currentPage) {
                pageButton.className = 'px-3 py-1.5 bg-accent-primary text-white font-medium rounded-lg text-sm';
            } else {
                pageButton.className = 'px-3 py-1.5 text-gray-400 hover:text-white bg-dark-700 hover:bg-dark-600 rounded-lg text-sm';
            }
            pageButton.textContent = i;
            pageButton.onclick = (event) => { event.stopPropagation(); changePage(i); };
            paginationContainer.appendChild(pageButton);
        }

        const nextButton = document.createElement('button');
        nextButton.className = 'p-2 text-gray-500 hover:text-white bg-dark-700 hover:bg-dark-600 rounded-lg transition-colors flex items-center justify-center';
        if (currentPage === totalPages || totalPages === 0) { 
            nextButton.className = 'p-2 text-dark-500 bg-dark-800 cursor-not-allowed rounded-lg flex items-center justify-center';
        }
        nextButton.innerHTML = '<i class="fas fa-chevron-right"></i>';
        nextButton.disabled = currentPage === totalPages || totalPages === 0;
        nextButton.onclick = (event) => { if (!nextButton.disabled) { event.stopPropagation(); changePage(currentPage + 1); } };
        paginationContainer.appendChild(nextButton);
    }

    function changePage(page) {
      const totalPages = Math.ceil(totalFilteredOrdersCount / itemsPerPage); // Usa totalFilteredOrdersCount
      if (page >= 1 && page <= totalPages) {
          currentPage = page;
          const search = document.getElementById('orderSearch')?.value || '';
          const payment = document.getElementById('filterPayment')?.value || '';
          const origin = document.getElementById('filterOrigin')?.value || '';
          fetchOrdersData(currentPage, { search, payment, origin });
      }
    }
    // ... (Funciones renderKanban, renderProductDetails, etc. se mantienen igual)
    function renderKanban() {
      const container = document.getElementById('kanbanBoard');
      const statuses = [
        { key: 0, label: 'En Tránsito', color: 'amber', icon: 'fa-truck' },
        { key: 1, label: 'Pronta Entrega', color: 'cyan', icon: 'fa-box-open' },
        { key: 2, label: 'Entregado', color: 'emerald', icon: 'fa-check-circle' },
        { key: 3, label: 'Cancelado', color: 'rose', icon: 'fa-times-circle' }
      ];
      container.innerHTML = statuses.map(status => {
        // Nota: Aquí se está filtrando sobre ordersData que ahora es solo la página actual.
        // Si quieres ver todas las órdenes en Kanban, necesitarías un endpoint de backend
        // que devuelva *todas* las órdenes o las órdenes por estado, sin paginar.
        // Para evitar recargar todas las órdenes, usaremos los datos actuales (que pueden estar filtrados/paginados).
        // Una solución real implicaría una llamada API específica para Kanban.
        const ordersInStatus = ordersData.filter(o => o.status === status.key); 
        return `
          <div class="kanban-column">
            <div class="flex items-center gap-3 mb-4">
              <div class="w-10 h-10 rounded-xl bg-${status.color}-500/20 flex items-center justify-center">
                <i class="fas ${status.icon} text-${status.color}-500"></i>
              </div>
              <div>
                <h3 class="font-semibold text-white">${status.label}</h3>
                <p class="text-xs text-gray-500">${ordersInStatus.length} órdenes</p>
              </div>
            </div>
            <div class="space-y-3">
              ${ordersInStatus.slice(0, 5).map(order => `
                <div onclick="openOrderModal('${order.id}')" 
                  class="glass-card p-4 rounded-xl cursor-pointer hover-glow border border-dark-600/30">
                  <div class="flex items-start justify-between mb-3">
                    <div class="flex flex-col">
                      <span class="font-bold text-white">${order.kommo_order_number}</span>
                      <span class="text-xs text-gray-500 mt-0.5">Orden #${order.id}</span>
                    </div>
                    <span class="text-lg font-bold text-white">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                  </div>
                  <div class="flex items-center justify-between text-sm mb-2">
                    <div class="flex items-center gap-1">
                      <i class="fas fa-user text-gray-400"></i>
                      <span class="text-gray-300 truncate max-w-[120px]">${order.customerName}</span>
                    </div>
                  </div>
                  <div class="flex justify-between items-center pt-2 border-t border-dark-600/30">
                    <div class="flex items-center gap-1 text-gray-400">${getPaymentIcon(order.paidStatus)}</div>
                    <div class="flex items-center gap-1 text-gray-400">${getStatusIcon(order.status)}</div>
                  </div>
                </div>
              `).join('')}
              ${ordersInStatus.length > 5 ? `<div class="text-center text-sm text-gray-500 py-2">+ ${ordersInStatus.length - 5} más</div>` : ''}
            </div>
          </div>
        `;
      }).join('');
    }
    
    function renderProductDetails(products) {
      if (!products || products.length === 0) return '<p class="text-gray-500">No hay productos en esta orden</p>';
      return products.map(product => {
        const productImages = product.product_urls || [];
        const initialImageUrl = (productImages.length > 0) ? productImages[0] : 'https://via.placeholder.com/80?text=Sin+imagen';
        return `
        <div class="flex items-start gap-4 p-3 bg-dark-700 rounded-xl mb-3 border border-dark-600/50 hover:border-accent-primary/30 transition-colors">
          <div class="w-20 h-20 rounded-lg bg-dark-600 border-2 border-dashed border-gray-700 flex items-center justify-center flex-shrink-0 overflow-hidden 
                      product-image-splash-container" 
               data-product-images='${JSON.stringify(productImages)}' 
               data-product-id="${product.product_id}">
            <img src="${initialImageUrl}" alt="${product.name}" class="w-full h-full object-contain current-product-splash-image">
          </div>
          <div class="flex-1 min-w-0">
            <p class="font-medium text-white line-clamp-1">${product.name}</p>
            <p class="text-sm text-gray-400 mt-1">${product.variant_title || 'Variante estándar'}</p>
              <div class="flex flex-wrap gap-2 mt-2">
                <span class="text-sm text-emerald-400 font-medium">$${parseFloat(product.price).toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                <span class="text-xs bg-blue-500/20 text-blue-300 px-2 py-0.5 rounded-full">x ${product.quantity || 1}</span>
              </div>
              ${product.sku ? `<span class="text-xs text-gray-500 mt-1">SKU: ${product.sku}</span>` : ''}
          </div>
        </div>
      `;
      }).join('');
    }

    // =============================================
    // MODALS & UI
    // =============================================
    function showLoading() { document.getElementById('loadingOverlay').classList.remove('hidden'); document.getElementById('loadingOverlay').classList.add('flex'); }
    function hideLoading() { document.getElementById('loadingOverlay').classList.add('hidden'); document.getElementById('loadingOverlay').classList.remove('flex'); }

    // CÓDIGO NUEVO: Función para mostrar notificaciones efímeras (Reemplaza y extiende tu lógica existente)
    /**
     * Muestra una notificación flotante efímera.
     * @param {string} message - El mensaje a mostrar.
     * @param {'success'|'error'} type - El tipo de notificación ('success' para verde, 'error' para rojo).
     * @param {boolean} [redirect=false] - Si es true, redirige al dashboard después de mostrar la notificación.
     */
    function showEphemeralNotification(message, type, redirect = false) {
        const notificationDiv = document.getElementById('ephemeralNotification');
        const messageSpan = document.getElementById('notificationMessage');
        const iconElement = notificationDiv.querySelector('i');

        // Primero, ocultar cualquier notificación visible para limpiarla
        closeEphemeralNotification(); // Asegura que se reinicien las clases de animación

        messageSpan.textContent = message;

        // Resetear clases de estilo y luego aplicar las correctas
        notificationDiv.classList.remove('ephemeral-notification-success', 'gradient-border-emerald');
        notificationDiv.classList.remove('ephemeral-notification-red', 'gradient-border-rose');
        iconElement.className = ''; // Limpiar clases de icono

        if (type === 'success') {
            notificationDiv.classList.add('ephemeral-notification-success', 'gradient-border-emerald');
            iconElement.classList.add('fas', 'fa-check-circle', 'text-emerald-400', 'text-xl');
        } else if (type === 'error') {
            notificationDiv.classList.add('ephemeral-notification-red', 'gradient-border-rose');
            iconElement.classList.add('fas', 'fa-exclamation-triangle', 'text-rose-400', 'text-xl');
        } else {
            // Default o tipo desconocido
            notificationDiv.classList.add('ephemeral-notification-red', 'gradient-border-rose');
            iconElement.classList.add('fas', 'fa-info-circle', 'text-gray-400', 'text-xl');
        }

        // Mostrar la notificación con animación
        notificationDiv.classList.remove('hidden', '-translate-y-full', 'opacity-0');
        notificationDiv.classList.add('translate-y-0', 'opacity-100');

        // Ocultar automáticamente después de 5 segundos
        setTimeout(() => {
            closeEphemeralNotification();
            if (redirect) {
                showSection('dashboard'); // Redirige si se solicitó
            }
        }, 5000);
    }

    // CÓDIGO NUEVO: Función para ocultar, con un pequeño delay para la animación
    function closeEphemeralNotification() {
        const ephemeralNotification = document.getElementById('ephemeralNotification');
        if (!ephemeralNotification.classList.contains('hidden')) {
            ephemeralNotification.classList.remove('translate-y-0', 'opacity-100');
            ephemeralNotification.classList.add('-translate-y-full', 'opacity-0');
            // Un pequeño retraso antes de ocultar completamente para permitir la transición
            setTimeout(() => { ephemeralNotification.classList.add('hidden'); }, 500);
        }
    }

    async function openOrderModal(orderId) {
        allProductSplashIntervals.forEach(clearInterval);
        allProductSplashIntervals = [];
        let order = ordersData.find(o => o.id.toString() === orderId); // Busca en los datos paginados actuales
        if (!order || !order.products || order.products.length === 0) {
            try {
                const response = await fetch(`${ORDERS_API_URL}/${orderId}`);
                if (!response.ok) {
                    throw new Error(`Error ${response.status}: No se pudo cargar la orden ${orderId}.`);
                }
                const fullOrderDetails = await response.json();
                
                // Actualiza la orden en el array 'ordersData' si la encuentra,
                // o la añade si no (esto es útil para la caché de modales)
                const index = ordersData.findIndex(o => o.id.toString() === orderId);
                if (index !== -1) {
                    ordersData[index] = fullOrderDetails;
                } else {
                    // Si la orden no estaba en la página actual, la añadimos para que esté disponible en la caché
                    ordersData.push(fullOrderDetails); 
                }
                order = fullOrderDetails;
            } catch (error) {
                console.error('Error al obtener los detalles de la orden:', error);
                alert(`No se pudo cargar el detalle de la orden ${orderId}.`);
                return;
            }
        }

        if (order.nota_n8n && order.nota_n8n.trim() !== '') {
            showEphemeralNotification(order.nota_n8n, 'error');
        }

        const modal = document.getElementById('orderModal');
        document.getElementById('modalTitle').textContent = `Orden ${order.kommo_order_number || `#${order.id}`}`;
        const subtotal = order.products.reduce((sum, p) => sum + (parseFloat(p.price || '0') * parseInt(p.quantity || '1')), 0);
        const shippingPrice = parseFloat(order.shipping_lines[0]?.price || '0');
        const discountAmount = parseFloat(order.order_data?.discount || '0');

        const isDeudor = order.is_deudor !== undefined ? order.is_deudor : false;
        const isBlacklist = order.is_blacklist !== undefined ? order.is_blacklist : false;

        const modalContent = document.getElementById('modalContent');
        modalContent.innerHTML = `
            <div class="grid grid-cols-1 lg:grid-cols-2 gap-8">
                <!-- Columna Izquierda: Cliente y Productos -->
                <div class="space-y-6">
                    <!-- Información del Cliente -->
                    <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
                        <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                            <div class="w-10 h-10 rounded-xl bg-blue-500/20 flex items-center justify-center">
                                <i class="fas fa-id-card text-blue-400 text-xl"></i>
                            </div>
                            Información del Cliente
                        </h4>
                        <div class="space-y-6">
                          <div class="flex gap-4 flex-wrap">
                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-exclamation-triangle"></i> Deudor
                                </p>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" id="deudorSwitch" ${isDeudor ? 'checked' : ''} onchange="updateOrderFlags('${order.id}', 'is_deudor', this.checked)">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-accent-primary rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-accent-primary"></div>
                                </label>
                            </div>

                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-ban"></i> Blacklist
                                </p>
                                <label class="relative inline-flex items-center cursor-pointer">
                                    <input type="checkbox" value="" class="sr-only peer" id="blacklistSwitch" ${isBlacklist ? 'checked' : ''} onchange="updateOrderFlags('${order.id}', 'is_blacklist', this.checked)">
                                    <div class="w-11 h-6 bg-gray-700 peer-focus:outline-none peer-focus:ring-2 peer-focus:ring-rose-500 rounded-full peer peer-checked:after:translate-x-full peer-checked:after:border-white after:content-[''] after:absolute after:top-[2px] after:left-[2px] after:bg-white after:border-gray-300 after:border after:rounded-full after:h-5 after:w-5 after:transition-all dark:border-gray-600 peer-checked:bg-rose-500"></div>
                                </label>
                            </div>
                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50 justify-center items-center">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-bolt"></i>  Acciones Rápidas
                                </p>
                                <button onclick="showQuickActions('${order.id}', '${order.kommo_order_number}')"
                                        class="btn-premium px-5 py-2.5 rounded-xl text-white font-medium">
                                    <i class="fas fa-bolt mr-2"></i>
                                </button>
                            </div>
                          </div>
                            <div>
                                <h5 class="text-gray-300 font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-id-card text-blue-500 text-sm"></i>
                                    Contacto Principal
                                </h5>
                                <div class="space-y-3">
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Nombre completo</p>
                                        <p class="text-white font-medium text-lg">${order.customerName || 'No disponible'}</p>
                                    </div>
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Teléfono</p>
                                        <p class="text-white font-medium">+521${order.contactInfo.phone || 'No disponible'}</p>
                                    </div>
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Correo electrónico</p>
                                        <p class="text-white font-medium break-all">${order.contactInfo.email || 'No disponible'}</p>
                                    </div>
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Tipo de Usuario</p>
                                        <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-300 capitalize">${order.user_type || 'cliente'}</span>
                                    </div>
                                </div>
                            </div>
                            <div>
                                <h5 class="text-gray-300 font-semibold mb-3 flex items-center gap-2">
                                    <i class="fas fa-map-marker-alt text-purple-500 text-sm"></i>
                                    Dirección de Envío
                                </h5>
                                <div class="space-y-3">
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Calle y número</p>
                                        <p class="text-white font-medium">${order.basic_data?.address || 'N/A'} ${order.basic_data?.domicilio || ''}</p>
                                    </div>
                                    <div class="grid grid-cols-2 gap-3">
                                        <div class="p-3 bg-dark-700 rounded-lg">
                                            <p class="text-gray-400 text-xs mb-1">Colonia</p>
                                            <p class="text-white font-medium">${order.basic_data?.colonia || 'N/A'}</p>
                                        </div>
                                        <div class="p-3 bg-dark-700 rounded-lg">
                                            <p class="text-gray-400 text-xs mb-1">Ciudad / Estado</p>
                                            <p class="text-white font-medium">${order.basic_data?.ciudad || 'N/A'} (${order.basic_data?.estado || 'N/A'})</p>
                                        </div>
                                    </div>
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Código Postal</p>
                                        <p class="text-white font-medium">${order.basic_data?.postal_code || 'N/A'}</p>
                                    </div>
                                    ${order.basic_data?.entre_calles ? `
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Entre Calles</p>
                                        <p class="text-white font-medium">${order.basic_data.entre_calles}</p>
                                    </div>
                                    ` : ''}
                                    ${order.basic_data?.referencia ? `
                                    <div class="p-3 bg-dark-700 rounded-lg">
                                        <p class="text-gray-400 text-xs mb-1">Referencia de Domicilio</p>
                                        <p class="text-white font-medium">${order.basic_data.referencia}</p>
                                    </div>
                                    ` : ''}
                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
                        <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                            <div class="w-10 h-10 rounded-xl bg-violet-500/20 flex items-center justify-center">
                                <i class="fas fa-boxes text-violet-400 text-xl"></i>
                            </div>
                            Productos (${order.products.length})
                        </h4>
                        <div class="space-y-3 max-h-[400px] overflow-y-auto pr-2">
                            ${renderProductDetails(order.products)}
                        </div>
                    </div>
                    ${order.order_data?.mapa ? `
                    <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
                        <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                            <div class="w-10 h-10 rounded-xl bg-orange-500/20 flex items-center justify-center">
                                <i class="fas fa-map-marker-alt text-orange-400 text-xl"></i>
                            </div>
                            Ubicación de Envío
                        </h4>
                        <div class="h-64 rounded-xl overflow-hidden border border-dark-600/50">
                            <iframe
                                src="${order.order_data.mapa.replace('https://maps.google.com/?', 'https://www.google.com/maps?')}&output=embed"
                                width="100%"
                                height="100%"
                                style="border:0;"
                                allowfullscreen=""
                                loading="lazy"
                                referrerpolicy="no-referrer-when-downgrade">
                            </iframe>
                        </div>
                    </div>
                ` : ''}
                </div>
                <div class="space-y-6">
                    <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
                        <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                            <div class="w-10 h-10 rounded-xl bg-cyan-500/20 flex items-center justify-center">
                                <i class="fas fa-info-circle text-cyan-400 text-xl"></i>
                            </div>
                            Estado y Flujo de la Orden
                        </h4>
                        <div class="space-y-4">
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                    <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                        <i class="fas fa-truck"></i> Estado de envío
                                    </p>
                                    <div class="flex items-center gap-2">
                                        <i class="fas ${STATUS_MAP[order.status]?.icon || 'fa-truck'} text-${STATUS_MAP[order.status]?.color || 'amber-400'}"></i>
                                        <span class="text-white font-medium">${STATUS_MAP[order.status]?.label || 'Desconocido'}</span>
                                    </div>
                                </div>
                                <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                    <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                        <i class="fas fa-credit-card"></i> Estado de pago
                                    </p>
                                    <div class="flex items-center gap-2">
                                        <i class="fas ${PAYMENT_STATUS_MAP[order.paidStatus]?.icon || 'fa-clock'} text-${PAYMENT_STATUS_MAP[order.paidStatus]?.color || 'amber-400'}"></i>
                                        <span class="text-white font-medium">${PAYMENT_STATUS_MAP[order.paidStatus]?.label || 'Desconocido'}</span>
                                    </div>
                                </div>
                            </div>
                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-stream"></i> Pipeline
                                </p>
                                 <div id="pipelineDisplay"
                                      class="flex items-center gap-2 cursor-pointer text-white font-medium hover:text-accent-primary transition-colors"
                                      onclick="showPipelineDetails(this)"
                                      data-pipeline-stages="${JSON.stringify(order.raw_pipeline_stages)
                                        .replace(/&/g, '&amp;')
                                        .replace(/"/g, '&quot;')}">
                                      <span class="flex-1">${order.pipeline || 'No especificado'}</span>
                                      ${order.raw_pipeline_stages && order.raw_pipeline_stages.length > 1 
                                        ? '<i id="pipelineArrow" class="fas fa-chevron-down text-xs transition-transform duration-300"></i>' 
                                        : ''}
                                    </div>
                                <div id="pipelineDetailsContainer" class="mt-2 hidden"></div> <!-- Contenedor para los detalles expandidos -->
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                    <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                        <i class="fas fa-calendar"></i> Fecha de compra
                                    </p>
                                    <p class="text-white font-medium">${formatDate(order.fecha_compra || order.order_data?.create_at)}</p>
                                </div>
                                <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                    <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                        <i class="fas fa-calendar-check"></i> Fecha confirmación
                                    </p>
                                    <p class="text-white font-medium">${order.fecha_confirmacion ? formatDate(order.fecha_confirmacion) : 'Pendiente'}</p>
                                </div>
                            </div>
                            <div class="grid grid-cols-2 gap-4">
                                <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                    <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                        <i class="fas fa-box-open"></i> Fecha entrega
                                    </p>
                                    <p class="text-white font-medium">${order.fecha_entrega ? formatDate(order.fecha_entrega) : 'Pendiente'}</p>
                                </div>
                                <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                    <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                        <i class="fas fa-money-bill-alt"></i> Fecha de pago
                                    </p>
                                    <p class="text-white font-medium">${order.fecha_pago ? formatDate(order.fecha_pago) : 'Pendiente'}</p>
                                </div>
                            </div>
                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-receipt"></i> Tipo de pago
                                </p>
                                <p class="text-white font-medium">${order.tipo_pago || 'No especificado'}</p>
                            </div>
                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-tag"></i> Código de trackeo
                                </p>
                                <p class="text-white font-medium flex items-center gap-2">
                                    ${order.tracking_code || 'No disponible'}
                                    ${order.tracking_code ? `<a href="${order.tracking_code}" target="_blank" class="text-accent-secondary hover:underline text-xs"><i class="fas fa-external-link-alt mr-1"></i>Ver</a>` : ''}
                                </p>
                            </div>
                            <div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-box"></i> Paquetería
                                </p>
                                <p class="text-white font-medium">${order.paqueteria || 'No especificada'}</p>
                            </div>
                            ${order.confirmador_name ? `<div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-user-check"></i> Confirmador
                                </p>
                                <p class="text-white font-medium">${order.confirmador_name}</p>
                            </div>` : ''}
                            ${order.cobrador_name ? `<div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-hand-holding-usd"></i> Cobrador
                                </p>
                                <p class="text-white font-medium">${order.cobrador_name}</p>
                            </div>` : ''}
                            ${order.NOTA ? `<div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-sticky-note"></i> Nota
                                </p>
                                <p class="text-white font-medium">${order.NOTA}</p>
                            </div>` : ''}
                            ${order.OBSERVACIONES ? `<div class="p-4 bg-dark-700 rounded-xl border border-dark-600/50">
                                <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                    <i class="fas fa-comment-dots"></i> Observaciones
                                </p>
                                <p class="text-white font-medium">${order.OBSERVACIONES}</p>
                            </div>` : ''}
                        </div>
                    </div>
                    <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
                        <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                            <div class="w-10 h-10 rounded-xl bg-pink-500/20 flex items-center justify-center">
                                <i class="fas fa-calculator text-pink-400 text-xl"></i>
                            </div>
                            Resumen de Orden
                        </h4>
                        <div class="space-y-4">
                            <div class="flex justify-between items-center py-2 border-b border-dark-600/50">
                                <span class="text-gray-400 flex items-center gap-2">
                                    <i class="fas fa-shopping-cart"></i> Subtotal (${order.products.reduce((sum, p) => sum + parseInt(p.quantity || 1), 0)} productos)
                                </span>
                                <span class="text-white font-medium">$${subtotal.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-dark-600/50">
                                <span class="text-gray-400 flex items-center gap-2">
                                    <i class="fas fa-shipping-fast"></i> Envío
                                </span>
                                <span class="text-emerald-400 font-medium">${shippingPrice > 0 ? `$${shippingPrice.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}` : 'Gratis'}</span>
                            </div>
                            <div class="flex justify-between items-center py-2 border-b border-dark-600/50">
                                <span class="text-gray-400 flex items-center gap-2">
                                    <i class="fas fa-percentage"></i> Descuentos
                                </span>
                                <span class="text-amber-400 font-medium">-$${discountAmount.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                            <div class="flex justify-between items-center pt-2">
                                <span class="text-lg font-bold text-white flex items-center gap-2">
                                    <i class="fas fa-money-bill-wave"></i> Total a pagar
                                </span>
                                <span class="text-2xl font-bold text-emerald-400">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
                            </div>
                        </div>
                    </div>
                    ${order.profs_url && order.profs_url.length > 0 ? `
                        <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
                            <p class="text-gray-400 text-xs mb-2 flex items-center gap-2">
                                <i class="fas fa-camera text-emerald-400"></i> Evidencia de Entrega
                            </p>
                            <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-3 mt-3">
                                ${order.profs_url.map(url => isImageFile(url) ? `
                                      <a href="${url}" target="_blank" class="block w-full h-32 overflow-hidden rounded-lg group">
                                        <img src="${url}" alt="Evidencia de entrega" class="w-full h-full object-cover transition-transform duration-300 group-hover:scale-105 border border-dark-600/50">
                                      </a>
                                    ` : `
                                      <a href="${url}" target="_blank" class="flex items-center gap-2 p-3 bg-dark-800 rounded-lg text-accent-primary hover:underline text-xs truncate border border-dark-600/50">
                                        <i class="fas fa-external-link-alt text-gray-500"></i>
                                        ${url.split('/').pop().substring(0, 20)}...
                                      </a>
                                    `).join('')}
                            </div>
                        </div>
                        ` : ''}
                </div>
            </div>
        `;
        modal.classList.remove('hidden');
        modal.classList.add('flex');

        const productImageElements = modalContent.querySelectorAll('.current-product-splash-image');
        productImageElements.forEach(imgElement => {
            const container = imgElement.closest('.product-image-splash-container');
            if (container) {
                const productImages = JSON.parse(container.dataset.productImages || '[]');
                if (productImages.length > 1) {
                    let currentImageIndex = 0;
                    currentImageIndex = (currentImageIndex + 1) % productImages.length;
                    const updateImage = () => {
                        imgElement.src = productImages[currentImageIndex];
                        currentImageIndex = (currentImageIndex + 1) % productImages.length;
                    };
                    const intervalId = setInterval(updateImage, 3000);
                    allProductSplashIntervals.push(intervalId);
                }
            }
        });
    }

    async function updateOrderFlags(orderId, flagName, flagValue) {
        showLoading();
        const updateURL = `${API_BASE_URL}/orders/${orderId}/flags`; // Endpoint para actualizar los flags

        try {
            const response = await fetch(updateURL, {
                method: 'PUT',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify({ [flagName]: flagValue })
            });

            if (!response.ok) {
                const errorData = await response.json();
                throw new Error(errorData.detail || 'Error al actualizar el estado de la orden.');
            }

            // Actualizar los datos en el array local 'ordersData'
            const orderIndex = ordersData.findIndex(order => order.id.toString() === orderId);
            if (orderIndex !== -1) {
                ordersData[orderIndex][flagName] = flagValue;
            }

            // Cerrar la notificación ephemeral antes de mostrar una nueva.
            closeEphemeralNotification();

            const notificationMessageSpan = document.getElementById('notificationMessage');
            const ephemeralNotificationDiv = document.getElementById('ephemeralNotification');

            notificationMessageSpan.textContent = `Estado "${flagName.replace('is_', '')}" actualizado`;
            ephemeralNotificationDiv.classList.remove('hidden', '-translate-y-full', 'opacity-0');
            ephemeralNotificationDiv.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => { closeEphemeralNotification(); }, 5000);

        } catch (error) {
            console.error('Error updating order flags:', error);
            // Usar la función closeEphemeralNotification para cerrar la notificación
            closeEphemeralNotification();

            const notificationMessageSpan = document.getElementById('notificationMessage');
            const ephemeralNotificationDiv = document.getElementById('ephemeralNotification');

            notificationMessageSpan.textContent = `Error al actualizar el estado: ${error.message}`;
            ephemeralNotificationDiv.classList.remove('hidden', '-translate-y-full', 'opacity-0');
            ephemeralNotificationDiv.classList.add('translate-y-0', 'opacity-100');
            setTimeout(() => { closeEphemeralNotification(); }, 5000);

        } finally {
            hideLoading();
        }
    }
    
    function closeOrderModal() {
      const modal = document.getElementById('orderModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
      allProductSplashIntervals.forEach(clearInterval);
      allProductSplashIntervals = [];
      closeEphemeralNotification(); 
    }

    document.getElementById('orderModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'orderModal') closeOrderModal();
    });

    async function openClientModal(clientId) {
      // Intenta encontrar el cliente en los datos paginados actuales
      const client = clientsData.find(c => c.id.toString() === clientId.toString()); 
      if (!client) { 
        alert('Cliente no encontrado en la página actual. Podría ser necesario recargar la página de clientes o buscarlo.'); 
        return; 
      }
      
      const modal = document.getElementById('clientModal');
      document.getElementById('clientModalTitle').textContent = `Cliente: ${client.name}`;
      const clientModalContent = document.getElementById('clientModalContent');
      clientModalContent.innerHTML = `
        <div class="grid grid-cols-1 lg:grid-cols-3 gap-8">
          <div class="lg:col-span-1 space-y-6">
            <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
              <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                <div class="w-10 h-10 rounded-xl bg-accent-tertiary/20 flex items-center justify-center">
                  <i class="fas fa-user-circle text-accent-tertiary text-xl"></i>
                </div>
                Detalles del Cliente
              </h4>
              <div class="space-y-4">
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Nombre completo</p>
                  <p class="text-white font-medium text-lg">${client.name || 'No disponible'}</p>
                </div>
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Correo electrónico</p>
                  <p class="text-white font-medium break-all">${client.email || 'No disponible'}</p>
                </div>
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Teléfono</p>
                  <p class="text-white font-medium">${client.phone || 'No disponible'}</p>
                </div>
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Tipo de Cliente</p>
                  <span class="px-2 py-1 rounded-full text-xs font-medium bg-blue-500/20 text-blue-300 capitalize">${client.userType || 'cliente'}</span>
                </div>
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Total Gastado</p>
                  <p class="text-white font-medium text-lg">$${client.totalSpent.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                </div>
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Número de Órdenes</p>
                  <p class="text-white font-medium text-lg">${client.orderCount}</p>
                </div>
                <div class="p-3 bg-dark-700 rounded-lg">
                  <p class="text-gray-400 text-xs mb-1">Última Orden</p>
                  <p class="text-white font-medium">${client.lastOrderDate ? formatDate(client.lastOrderDate) : 'N/A'}</p>
                </div>
              </div>
            </div>
          </div>
          <div class="lg:col-span-2 space-y-6">
            <div class="glass-card rounded-2xl p-6 border border-dark-600/50">
              <h4 class="flex items-center gap-3 text-white font-semibold mb-5">
                <div class="w-10 h-10 rounded-xl bg-accent-primary/20 flex items-center justify-center">
                  <i class="fas fa-shopping-bag text-accent-primary text-xl"></i>
                </div>
                Órdenes de ${client.name} (${client.orders.length})
              </h4>
              <div class="space-y-4 max-h-[500px] overflow-y-auto pr-2">
                ${client.orders.length > 0 ? client.orders.map(order => `
                  <div class="glass-card p-4 rounded-xl hover-glow cursor-pointer transition-all duration-300 border border-dark-600/50" onclick="closeClientModal(); openOrderModal('${order.id}')">
                    <div class="flex items-center justify-between gap-4">
                      <div class="flex items-start gap-3">
                        <div class="w-10 h-10 rounded-xl bg-dark-700 flex items-center justify-center flex-shrink-0">
                          <i class="fas fa-receipt text-gray-400"></i>
                        </div>
                        <div>
                          <p class="font-bold text-white">${order.kommo_order_number || `#${order.id}`}</p>
                          <p class="text-xs text-gray-500 mt-0.5">${formatDate(order.fecha_compra)}</p>
                        </div>
                      </div>
                      <div class="text-right">
                        <p class="font-bold text-white text-lg">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</p>
                        <div class="flex items-center gap-2 justify-end mt-1">
                          <span class="text-xs ${PAYMENT_STATUS_MAP[order.paid_status]?.class || 'bg-gray-500/20 text-gray-400'} px-2 py-0.5 rounded-full">${PAYMENT_STATUS_MAP[order.paid_status]?.label || 'Desconocido'}</span>
                          <span class="text-xs ${STATUS_MAP[order.status]?.class || 'bg-gray-500/20 text-gray-400'} px-2 py-0.5 rounded-full">${STATUS_MAP[order.status]?.label || 'Desconocido'}</span>
                        </div>
                      </div>
                    </div>
                  </div>
                `).join('') : '<p class="text-gray-500 text-center">Este cliente no ha realizado órdenes aún.</p>'}
              </div>
            </div>
          </div>
        </div>
      `;
      modal.classList.remove('hidden');
      modal.classList.add('flex');
    }

    function closeClientModal() {
      const modal = document.getElementById('clientModal');
      modal.classList.add('hidden');
      modal.classList.remove('flex');
    }

    document.getElementById('clientModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'clientModal') closeClientModal();
    });
    
    // =============================================
    // FILTERS & UTILITIES
    // =============================================
    function filterOrders() {
        currentPage = 1; // Siempre vuelve a la primera página al aplicar nuevos filtros
        const search = document.getElementById('orderSearch')?.value || '';
        const payment = document.getElementById('filterPayment')?.value || '';
        const origin = document.getElementById('filterOrigin')?.value || '';

        fetchOrdersData(currentPage, { search, payment, origin });
    }
    
    function clearFilters() {
      document.getElementById('orderSearch').value = '';
      document.getElementById('filterPayment').value = '';
      document.getElementById('filterOrigin').value = '';
      fetchOrdersData(1, {}); // Llama a fetchOrdersData sin filtros para reiniciar la tabla
    }

    function exportOrders() {
      // Para la exportación, podrías querer exportar todas las órdenes filtradas, no solo la página actual.
      // Esto requeriría un nuevo endpoint en el backend que devuelva todas las órdenes que coinciden con los filtros, sin paginación.
      // Por ahora, exportará solo las órdenes de la página actual.
      if (ordersData.length === 0) { alert('No hay órdenes para exportar'); return; }
      const csvContent = [
        ["ID Orden", "Kommo Order", "Cliente", "Total (MXN)", "Estado", "Origen", "Fecha", "Pago", "Teléfono", "Email"],
        ...ordersData.map(order => [
          order.id, order.kommo_order_number, `"${order.customerName}"`, order.total,
          STATUS_MAP[order.status]?.label || 'Desconocido', order.origen_compra, formatDate(order.date),
          PAYMENT_STATUS_MAP[order.paidStatus]?.label || 'Desconocido', order.contactInfo.phone, order.contactInfo.email
        ])
      ].map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `ordenes-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }
    
    function exportClients() {
      // Similar a orders, esto exportará solo los clientes de la página actual.
      // Se necesitaría un endpoint backend sin paginación para exportar todos los filtrados.
      if (clientsData.length === 0) { alert('No hay clientes para exportar'); return; }
      const csvContent = [
        ["ID Cliente", "Nombre", "Email", "Teléfono", "Tipo de Cliente", "Total Gastado", "Número de Órdenes", "Última Orden"],
        ...clientsData.map(client => [ client.id, `"${client.name}"`, client.email, client.phone, client.userType, client.totalSpent, client.orderCount, client.lastOrderDate ? formatDate(client.lastOrderDate) : 'N/A' ])
      ].map(row => row.join(',')).join('\n');
      const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
      const url = URL.createObjectURL(blob);
      const link = document.createElement('a');
      link.setAttribute('href', url);
      link.setAttribute('download', `clientes-${new Date().toISOString().split('T')[0]}.csv`);
      link.style.visibility = 'hidden';
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function formatDateOld(dateString) {
      if (!dateString) return 'N/A';
      const date = new Date(dateString);
      return date.toLocaleDateString('es-MX', { day: '2-digit', month: 'short', year: 'numeric' });
    }

    function formatDate(dateString) {
      if (!dateString) return 'N/A';
      
      const date = new Date(dateString);
      
      // Si la fecha no es válida
      if (isNaN(date.getTime())) return 'Fecha inválida';
      
      const day = date.getDate().toString().padStart(2, '0');
      const months = ['ene', 'feb', 'mar', 'abr', 'may', 'jun', 'jul', 'ago', 'sep', 'oct', 'nov', 'dic'];
      const month = months[date.getMonth()];
      const year = date.getFullYear();
      
      return `${day} ${month} ${year}`;
    }
    
    function isImageFile(url) {
      if (!url || typeof url !== 'string') return false;
      const imageExtensions = ['.jpg', '.jpeg', '.png', '.gif', '.webp', '.bmp', '.svg'];
      const urlPath = url.split('?')[0];
      const lowerUrlPath = urlPath.toLowerCase();
      return imageExtensions.some(ext => lowerUrlPath.endsWith(ext));
    }

    // =============================================
    // COMMAND PALETTE & NOTIFICATIONS (Sin cambios)
    // =============================================
    function openCommandPalette() {
      document.getElementById('commandPalette').classList.remove('hidden');
      document.getElementById('commandPalette').classList.add('flex');
      document.getElementById('commandInput').focus();
    }
    
    function closeCommandPalette() {
      document.getElementById('commandPalette').classList.add('hidden');
      document.getElementById('commandPalette').classList.remove('flex');
      document.getElementById('commandInput').value = '';
    }
    
    function handleCommandSearch(query) {
      const results = document.getElementById('commandResults');
      if (!query.trim()) {
        results.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">Escribe para buscar...</p>';
        return;
      }
      // NOTA: ordersData ahora contiene solo la página actual, esta búsqueda solo buscará en esa página.
      // Para una búsqueda global, se necesitaría un endpoint de búsqueda global en el backend.
      const matchedOrders = ordersData.filter(o => 
        o.id.toString().includes(query) ||
        o.kommo_order_number.toLowerCase().includes(query.toLowerCase()) ||
        o.customerName.toLowerCase().includes(query.toLowerCase()) ||
        (o.products && o.products.some(p => p.name.toLowerCase().includes(query.toLowerCase())))).slice(0, 5);
      
      if (matchedOrders.length === 0) {
        results.innerHTML = '<p class="text-gray-500 text-sm p-4 text-center">No se encontraron resultados</p>';
        return;
      }
      
      results.innerHTML = matchedOrders.map(order => `
        <div onclick="closeCommandPalette(); openOrderModal('${order.id}')" 
          class="command-item flex items-center gap-4 p-3 rounded-xl cursor-pointer transition-colors hover:bg-dark-700/50">
          <div class="w-10 h-10 rounded-lg bg-accent-primary/20 flex items-center justify-center">
            <i class="fas fa-shopping-bag text-accent-primary"></i>
          </div>
          <div class="flex-1">
            <p class="text-white font-medium">${order.kommo_order_number} - Orden #${order.id}</p>
            <p class="text-sm text-gray-500">Cliente: ${order.customerName}</p>
            <p class="text-xs text-gray-600">${order.products.map(p => p.name).slice(0, 1).join(', ')}${order.products.length > 1 ? ' + ' + (order.products.length - 1) + ' más' : ''}</p>
          </div>
          <span class="text-sm text-gray-500 font-medium">$${order.total.toLocaleString(undefined, {minimumFractionDigits: 2, maximumFractionDigits: 2})}</span>
        </div>
      `).join('');
    }
    
    document.getElementById('commandPalette')?.addEventListener('click', (e) => {
      if (e.target.id === 'commandPalette') closeCommandPalette();
    });

    function toggleNotificationsPanel() {
      const panel = document.getElementById('notificationsPanel');
      panel.classList.toggle('hidden');
      if (!panel.classList.contains('hidden')) {
        setTimeout(() => {
          const handleClickOutside = (event) => {
            if (!panel.contains(event.target) && !event.target.closest('button[onclick="toggleNotificationsPanel()"]')) {
              panel.classList.add('hidden');
              document.removeEventListener('click', handleClickOutside);
            }
          };
          document.addEventListener('click', handleClickOutside);
        }, 0);
      }
    }

    async function getOrderById(orderId) {
      try {
          const response = await fetch(`${ORDERS_API_URL}/${orderId}`);
          if (!response.ok) {
              throw new Error(`Error ${response.status}: No se pudo cargar la orden ${orderId}.`);
          }
          return await response.json();
      } catch (error) {
          console.error('Error al obtener los detalles de la orden:', error);
          alert(`No se pudo cargar el detalle de la orden ${orderId}.`);
          return;
      }
    }

    // =============================================
    // AI CHAT (Sin cambios)
    // =============================================
    const AI_WEBHOOK_URL = "https://n8nerp.omexan.com/webhook/19745862-c44b-4a05-af8d-041fbbca3c0c";

    function getOrCreateAiSessionId() {
        let sessionId = localStorage.getItem('aiSessionId');
        if (!sessionId) {
            sessionId = 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, function(c) {
                const r = Math.random() * 16 | 0, v = c == 'x' ? r : (r & 0x3 | 0x8);
                return v.toString(16);
            });
            localStorage.setItem('aiSessionId', sessionId);
        }
        return sessionId;
    }

    function openAIChat() {
      const panel = document.getElementById('aiChatPanel');
      panel.classList.remove('hidden');
      panel.classList.add('flex');
      document.getElementById('aiChatInput').focus();
    }

    function closeAIChat() {
      const panel = document.getElementById('aiChatPanel');
      panel.classList.add('hidden');
      panel.classList.remove('flex');
    }

    function toggleAIChat() {
      const panel = document.getElementById('aiChatPanel');
      if (panel.classList.contains('hidden')) { openAIChat(); } else { closeAIChat(); }
    }
    
    async function sendAIMessage() {
      const input = document.getElementById('aiChatInput');
      const sendButton = document.querySelector('#aiChatPanel .p-4 button');
      const message = input.value.trim();

      if (!message) return;

      const container = document.getElementById('aiChatMessages');

      // Mostrar el mensaje del usuario
      container.innerHTML += `<div class="flex justify-end">
          <div class="bg-gradient-to-r from-accent-primary to-accent-secondary rounded-2xl rounded-tr-none px-4 py-3 max-w-[85%]">
            <p class="text-sm text-white">${message}</p>
          </div>
        </div>`;
      input.value = '';
      container.scrollTop = container.scrollHeight;

      // Deshabilitar la entrada y el botón mientras se espera la respuesta
      input.disabled = true;
      sendButton.disabled = true;
      sendButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';

      try {
        const aiSessionId = getOrCreateAiSessionId();
        const response = await fetch(AI_WEBHOOK_URL, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({ text: message, sessionId: currentUser.email })
        });

        if (!response.ok) {
          const errorData = await response.json().catch(() => ({}));
          throw new Error(errorData.detail || `Error API: ${response.status} - ${response.statusText}`);
        }

        let aiResponse;
        try {
          // Clona la respuesta para poder leerla como JSON y luego como texto si falla
          const responseClone = response.clone();
          aiResponse = await responseClone.json();

          console.log("Respuesta JSON:", aiResponse); // Loguea la respuesta completa

          // Validar si la respuesta es un objeto con 'shopify_order_id' y 'profs_url'
          const isValidJSON = typeof aiResponse === 'object' && aiResponse !== null && aiResponse.hasOwnProperty('shopify_order_id') && aiResponse.hasOwnProperty('profs_url');

          if (isValidJSON) {
            console.log("La respuesta JSON es un objeto válido."); // Loguea si la respuesta es válida

            // Procesar el objeto directamente
            const order = aiResponse; // No necesitamos un loop, ya que es un solo objeto
            console.log("Procesando orden:", order); // Loguea la orden que se está procesando

            if (Array.isArray(order.profs_url)) {
              console.log("URLs de 'profs_url':", order.profs_url); // Loguea las URLs

              order.profs_url.forEach(url => {
                const imageId = `image-${Math.random().toString(36).substring(2, 15)}`; // Genera un ID único para cada imagen
                container.innerHTML += `<div class="flex gap-3">
                    <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center flex-shrink-0">
                      <i class="fas fa-robot text-white text-sm"></i>
                    </div>
                    <div class="bg-dark-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                      <img id="${imageId}" src="${url}" alt="Imagen de orden ${order.shopify_order_id}" style="max-width: 100%; height: auto; cursor: pointer;" onclick="showFullscreen('${imageId}')">
                      <div class="flex justify-between mt-2">
                        <button class="bg-accent-primary hover:bg-accent-secondary text-white font-bold py-2 px-4 rounded" onclick="downloadImage('${url}')">
                          Descargar
                        </button>
                        <button class="bg-gray-700 hover:bg-gray-600 text-white font-bold py-2 px-4 rounded" onclick="showFullscreen('${imageId}')">
                          Pantalla Completa
                        </button>
                      </div>
                    </div>
                  </div>`;
              });
            } else {
              //Si prods_url no es un array, mostrar un error
              container.innerHTML += `<div class="flex gap-3">
                  <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center flex-shrink-0">
                    <i class="fas fa-robot text-white text-sm"></i>
                  </div>
                  <div class="bg-dark-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                    <p class="text-sm text-rose-400">Error: El formato de 'profs_url' es incorrecto para la orden ${order.shopify_order_id}.</p>
                  </div>
                </div>`;
            }
          } else {
            console.log("La respuesta JSON NO es válida."); // Loguea si la respuesta no es válida
            // Si el formato no coincide, mostrar un mensaje de error
            container.innerHTML += `<div class="flex gap-3">
                <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center flex-shrink-0">
                  <i class="fas fa-robot text-white text-sm"></i>
                </div>
                <div class="bg-dark-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                  <p class="text-sm text-gray-200">No pude obtener una respuesta de la IA. Intenta reformular tu pregunta.</p>
                </div>
              </div>`;
          }
        } catch (jsonError) {
          // Si no se puede parsear como JSON, tratar como texto
          console.error("Error al parsear JSON:", jsonError);
          const aiText = await response.text() || "No pude obtener una respuesta de la IA. Intenta reformular tu pregunta.";
          container.innerHTML += `<div class="flex gap-3">
              <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center flex-shrink-0">
                <i class="fas fa-robot text-white text-sm"></i>
              </div>
              <div class="bg-dark-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
                <p class="text-sm text-gray-200">${aiText}</p>
              </div>
            </div>`;
        }

        container.scrollTop = container.scrollHeight;

      } catch (error) {
        console.error('Error al obtener la respuesta de la IA:', error);
        container.innerHTML += `<div class="flex gap-3">
            <div class="w-9 h-9 rounded-xl bg-gradient-to-br from-accent-primary to-accent-secondary flex items-center justify-center flex-shrink-0">
              <i class="fas fa-robot text-white text-sm"></i>
            </div>
            <div class="bg-dark-700 rounded-2xl rounded-tl-none px-4 py-3 max-w-[85%]">
              <p class="text-sm text-rose-400">Error: ${error.message}. Por favor, inténtalo de nuevo más tarde.</p>
            </div>
          </div>`;
        container.scrollTop = container.scrollHeight;
      } finally {
        // Habilitar la entrada y el botón nuevamente
        input.disabled = false;
        sendButton.disabled = false;
        sendButton.innerHTML = '<i class="fas fa-paper-plane"></i>';
        input.focus();
      }
    }

    // Funciones fuera de sendAIMessage
    function downloadImage(url) {
      const link = document.createElement('a');
      link.href = url;
      link.download = 'image.jpg'; // Puedes cambiar el nombre del archivo
      document.body.appendChild(link);
      link.click();
      document.body.removeChild(link);
    }

    function showFullscreen(imageId) {
      const img = document.getElementById(imageId);
      if (!img) return;

      // Crear el overlay
      const overlay = document.createElement('div');
      overlay.style.position = 'fixed';
      overlay.style.top = '0';
      overlay.style.left = '0';
      overlay.style.width = '100%';
      overlay.style.height = '100%';
      overlay.style.backgroundColor = 'rgba(0, 0, 0, 0.8)';
      overlay.style.zIndex = '9999';
      overlay.style.display = 'flex';
      overlay.style.justifyContent = 'center';
      overlay.style.alignItems = 'center';
      overlay.onclick = () => {
        document.body.removeChild(overlay); // Cerrar al hacer clic fuera de la imagen
      };

      // Crear la imagen en pantalla completa
      const fullImg = document.createElement('img');
      fullImg.src = img.src;
      fullImg.alt = img.alt;
      fullImg.style.maxWidth = '90%';
      fullImg.style.maxHeight = '90%';
      fullImg.style.objectFit = 'contain'; // Asegura que la imagen se ajuste sin deformarse

      // Agregar la imagen al overlay
      overlay.appendChild(fullImg);

      // Agregar el overlay al body
      document.body.appendChild(overlay);
    }

    // =============================================
    // CHARTS & OTHERS (Sin cambios)
    // =============================================
    function initCharts() {
      const convCtx = document.getElementById('conversionsChart')?.getContext('2d');
      if (convCtx) {
        new Chart(convCtx, {
          type: 'bar',
          data: {
            labels: ['Lun', 'Mar', 'Mié', 'Jue', 'Vie', 'Sáb', 'Dom'],
            datasets: [{
              label: 'Conversiones',
              data: [45, 52, 38, 65, 48, 72, 55],
              backgroundColor: 'rgba(59, 130, 246, 0.8)',
              borderRadius: 8
            }]
          },
          options: {
            responsive: true,
            maintainAspectRatio: false,
            plugins: { legend: { display: false } },
            scales: {
              x: { grid: { display: false }, ticks: { color: '#9ca3af' } },
              y: { grid: { color: 'rgba(75, 85, 99, 0.2)' }, ticks: { color: '#9ca3af' } }
            }
          }
        });
      }
    }
    
    function renderBlacklist() {
      const container = document.getElementById('blacklistList');
      container.innerHTML = `
        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-xl bg-rose-500/20 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-user-slash text-rose-500 text-xl"></i>
              </div>
              <div>
                <h4 class="text-lg font-semibold text-white">Roberto Malo</h4>
                <p class="text-gray-400 mt-1">Fraude recurrente - 3 intentos fallidos</p>
                <p class="text-xs text-gray-600 mt-2">Agregado: 10 de octubre, 2023</p>
              </div>
            </div>
            <button class="p-2 text-gray-500 hover:text-rose-500 transition-colors">
              <i class="fas fa-ellipsis-v"></i>
            </button>
          </div>
        </div>`;
    }

    function openQuickActionsModal(orderNumber) {
        document.getElementById('quickActionsModal').classList.remove('hidden');
        document.getElementById('quickActionsModal').classList.add('flex');
        document.getElementById('quickActionsModal').dataset.orderNumber = orderNumber; // Almacena el número de orden en el modal
    }

    function closeQuickActionsModal() {
        document.getElementById('quickActionsModal').classList.add('hidden');
        document.getElementById('quickActionsModal').classList.remove('flex');
    }

    async function createLead() {
        const leadReason = document.getElementById('leadReason').value;
        const orderId = sessionStorage.getItem('currentOrderId');
        const kommoOrderNumber = sessionStorage.getItem('currentKommoOrderNumber');

        if (!leadReason.trim()) {
            showEphemeralNotification("Por favor, ingresa un motivo para crear el lead.", 'error');
            return;
        }

        if (!orderId || !kommoOrderNumber) {
            showEphemeralNotification("No hay una orden seleccionada para crear el lead. Abre el detalle de una orden y selecciona 'Acciones Rápidas'.", 'error', true); // Redirige al dashboard
            return;
        }

        const createLeadURL = "https://n8nerp.omexan.com/webhook/6da1100b-19dc-434a-94ae-7fde15634c3f";
        showLoading();

        try {
            const payload = {
                shopify_order_id: orderId,
                kommo_order_number: kommoOrderNumber,
                email: currentUser.email,
                motivo: leadReason
            };

            const response = await fetch(createLeadURL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json();

            if (data.status === 200) { // Éxito
                showEphemeralNotification(data.message || 'Lead creado con éxito!', 'success', true); // Redirige al dashboard
            } else if (data.status === 401) { // Error de permiso (401)
                showEphemeralNotification(data.message || 'No tienes permiso para realizar esta acción.', 'error', true); // Redirige al dashboard
            } else { // Otros errores del servidor o lógicos (ej. status 500, o un status 200 con un mensaje de error dentro)
                throw new Error(data.message || 'Error desconocido al crear el lead.');
            }
            
            // Limpiar sessionStorage y ocultar formulario solo si la operación fue "exitosa" desde la perspectiva de la UI
            sessionStorage.removeItem('currentOrderId');
            sessionStorage.removeItem('currentKommoOrderNumber');
            document.getElementById('createLeadForm').classList.add('hidden'); 
            
        } catch (error) {
            console.error('Error creating lead:', error);
            showEphemeralNotification(error.message || 'Ocurrió un error inesperado al crear el lead.', 'error', true); // Siempre redirige en caso de error inesperado
        } finally {
            hideLoading();
        }
    }

     async function addOrderToDrive() {
        const orderId = sessionStorage.getItem('currentOrderId');
        const kommoOrderNumber = sessionStorage.getItem('currentKommoOrderNumber');
        const userEmail = currentUser ? currentUser.email : null;

        if (!orderId || !kommoOrderNumber || !userEmail) {
            showEphemeralNotification("No se pudo obtener la información de la orden o del usuario. Intenta de nuevo desde el detalle de la orden.", 'error', true);
            return;
        }

        showLoading();

        try {
            const payload = {
                kommo_order_number: kommoOrderNumber,
                email: userEmail
            };

            const response = await fetch(ADD_TO_DRIVE_API_URL, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json'
                },
                body: JSON.stringify(payload)
            });

            const data = await response.json(); // Asume que la respuesta siempre es JSON

            if (data.status === 200) {
                showEphemeralNotification(data.message || 'Orden añadida al Drive de Dirección con éxito!', 'success', true);
            } else if (data.status === 401) {
                showEphemeralNotification(data.message || 'No tienes permiso para añadir direcciones a Drive.', 'error', true);
            } else { // Otros errores
                throw new Error(data.message || 'Error desconocido al añadir a Drive.');
            }
            
            // Limpiar sessionStorage y redirigir siempre después de intentar la acción
            sessionStorage.removeItem('currentOrderId');
            sessionStorage.removeItem('currentKommoOrderNumber');

        } catch (error) {
            console.error('Error adding to Drive:', error);
            showEphemeralNotification(error.message || 'Ocurrió un error inesperado al añadir a Drive.', 'error', true);
        } finally {
            hideLoading();
        }
    }

    document.getElementById('quickActionsModal')?.addEventListener('click', (e) => {
      if (e.target.id === 'quickActionsModal') closeQuickActionsModal();
    });

    
    function showQuickActions(orderId, kommoOrderNumber) {
      closeOrderModal();
      sessionStorage.setItem('currentOrderId', orderId);
      sessionStorage.setItem('currentKommoOrderNumber', kommoOrderNumber);
      showSection('acciones');
    }

    function renderDebtors() {
      const container = document.getElementById('debtorsList');
      container.innerHTML = `
        <div class="glass-card rounded-2xl p-6">
          <div class="flex items-start justify-between">
            <div class="flex items-start gap-4">
              <div class="w-12 h-12 rounded-xl bg-orange-500/20 flex items-center justify-center flex-shrink-0">
                <i class="fas fa-hand-holding-usd text-orange-500 text-xl"></i>
              </div>
              <div>
                <h4 class="text-lg font-semibold text-white">Empresa X SA</h4>
                <p class="text-gray-400 mt-1">Deuda de $15,000.50 MXN</p>
                <div class="flex items-center gap-2 mt-2">
                  <span class="text-xs bg-rose-500/20 text-rose-400 px-2 py-0.5 rounded-full">45 días vencidos</span>
                  <span class="text-xs bg-amber-500/20 text-amber-400 px-2 py-0.5 rounded-full">Alto riesgo</span>
                </div>
              </div>
            </div>
            <div class="text-right">
              <p class="text-2xl font-bold text-rose-500">$15,000.50</p>
              <button class="mt-2 px-3 py-1 text-xs font-medium rounded-lg bg-rose-500/20 text-rose-400 hover:bg-rose-500/30 transition-colors">
                Contactar ahora
              </button>
            </div>
          </div>
        </div>`;
    }
  </script>
</body>
</html>
